<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AGA Destine Holding ‚Äì V6 Firestore FULL</title>
  <meta name="description" content="PlatformƒÉ single-file AGA: Organizator (parolƒÉ), Votant (link unic), vot ponderat, WhatsApp/Email link, export PDF/JSON/CSV, Firestore live, TEST‚ÜîPROD, √Ænchidere sesiune.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    :root{ --blue:#0d47a1; --blue600:#1e40af; --green:#0f9d58; --red:#c62828; --amber:#f59e0b;
           --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.06); }
    *{box-sizing:border-box} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:#0b1220; padding:18px}
    .container{max-width:1180px;margin:0 auto}
    header{display:flex;gap:14px;align-items:center;background:linear-gradient(135deg,var(--blue),var(--blue600));color:#fff;border-radius:16px;padding:22px;box-shadow:var(--shadow)}
    .title{font-weight:800;font-size:1.22rem}
    .badge{padding:6px 10px;border-radius:999px;background:#ffffff1a;border:1px solid #ffffff3a;font-weight:700}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:18px;margin-top:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    label{font-weight:700}
    input,select,button,textarea{font-family:inherit;font-size:1rem}
    .input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:0;border-radius:12px;cursor:pointer;background:var(--blue);color:#fff;font-weight:800;box-shadow:var(--shadow);transition:.2s transform}
    .btn.secondary{background:#11182714;color:#0b1220}
    .btn.green{background:var(--green)} .btn.red{background:var(--red)} .btn.amber{background:var(--amber);color:#111827}
    .btn:active{transform:translateY(1px)}
    .hidden{display:none !important}
    .muted{color:var(--muted)} .small{font-size:.92rem}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eef1f5;text-align:left;vertical-align:top}
    .chip{padding:6px 10px;border-radius:999px;background:#0b122010;border:1px dashed #d1d5db}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    .kpi .box{background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:14px;text-align:center}
    .kpi .val{font-size:1.15rem;font-weight:800}
    footer{margin-top:12px;text-align:center}
    code{background:#0b122010;padding:2px 6px;border-radius:6px}
    @media (max-width:980px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr} .kpi{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div style="font-size:40px">üó≥Ô∏è</div>
    <div>
      <div class="title">AGA Destine Holding ‚Äî V6 Firestore FULL</div>
      <div class="small">Single-file ‚Ä¢ Organizer & Votant ‚Ä¢ Firestore Live ‚Ä¢ Build: <span id="buildTs"></span></div>
    </div>
    <div style="margin-left:auto" class="row">
      <span class="badge" id="envBadge">TEST</span>
      <span class="badge" id="roleBadge">‚Äî</span>
    </div>
  </header>

  <!-- Gateway -->
  <section class="card" id="secGate">
    <h2>Acces</h2>
    <div class="grid cols-2">
      <div>
        <h3>Mod Votant</h3>
        <p class="small muted">Folosi»õi linkul unic cu <code>?t=TOKEN</code>. FƒÉrƒÉ cont Google.</p>
        <div class="row"><a class="btn secondary" id="btnSampleVoter">Exemplu link votant</a></div>
      </div>
      <div>
        <h3>Mod Organizator</h3>
        <label>ParolƒÉ</label>
        <input id="orgPass" class="input" placeholder="Introduce»õi parola" type="password">
        <div class="row">
          <button class="btn" id="btnOrgLogin">IntrƒÉ ca Organizator</button>
          <button class="btn amber" id="btnToggleEnv">ComutƒÉ Mod (TEST‚ÜîPROD)</button>
        </div>
        <div class="small muted">ParolƒÉ: <code>DESTINE2025</code>. Mod implicit: <b>TEST</b>.</div>
      </div>
    </div>
  </section>

  <!-- Organizer -->
  <section class="card hidden" id="secOrganizer">
    <h2>Mod Organizator</h2>
    <div class="grid cols-3">
      <div class="chip">Proiect Firestore: <b id="projectName">destineaga</b></div>
      <div class="chip">Sesiune: <b id="meetingKey"></b></div>
      <div class="chip">Sincronizare: <b id="syncStatus">offline</b></div>
    </div>

    <h3 style="margin-top:16px">1) Import date</h3>
    <div class="grid cols-3">
      <div>
        <label>Ac»õionari (CSV)</label>
        <input type="file" id="fileShareholders" accept=".csv" class="input"/>
        <div class="small muted">Header acceptat: <code>Nume,Actiuni,Telefon,Email,ProcurƒÉPentru</code> (acceptƒÉm »ôi <code>ProcuraPentru</code>)</div>
      </div>
      <div>
        <label>Ordinea de zi (JSON)</label>
        <input type="file" id="fileAgenda" accept=".json" class="input"/>
        <div class="small muted">Format: [{"id":"p1","title":"..."}]</div>
      </div>
      <div class="row" style="align-items:flex-end">
        <button class="btn secondary" id="btnLoadDemos">√éncarcƒÉ demo</button>
        <button class="btn" id="btnClearAll">»òterge tot</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ac»õionari importa»õi</h3>
        <table id="tblShareholders"><thead><tr><th>#</th><th>Nume</th><th>Ac»õiuni</th><th>Telefon</th><th>Email</th><th>ProcurƒÉ pentru</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ordinea de zi</h3>
        <table id="tblAgenda"><thead><tr><th>#</th><th>ID</th><th>Punct</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <h3>2) Linkuri unice »ôi trimitere</h3>
    <div class="row">
      <button class="btn green" id="btnGenerateLinks">GenereazƒÉ linkuri</button>
      <button class="btn secondary" id="btnCopyAll">CopiazƒÉ lista</button>
      <button class="btn secondary" id="btnExportLinksCSV">Export CSV linkuri</button>
    </div>
    <div class="card" id="linksBox" style="max-height:280px;overflow:auto;margin-top:10px">
      <table id="tblLinks"><thead><tr><th>#</th><th>Nume</th><th>Link unic</th><th>WhatsApp</th><th>Email</th><th>Copy</th></tr></thead><tbody></tbody></table>
    </div>

    <h3>3) Monitorizare sesiune live</h3>
    <div class="kpi">
      <div class="box"><div class="small muted">Total ac»õionari</div><div class="val" id="kTotalSh">0</div></div>
      <div class="box"><div class="small muted">Prezen»õi (au deschis linkul)</div><div class="val" id="kPresent">0</div></div>
      <div class="box"><div class="small muted">Voturi exprimate</div><div class="val" id="kCast">0</div></div>
      <div class="box"><div class="small muted">Cronometru</div><div class="val" id="kTimer">00:00</div></div>
      <div class="box"><div class="small muted">Stare sesiune</div><div class="val" id="kClosed">DeschisƒÉ</div></div>
    </div>

    <div class="grid cols-2" style="margin-top:12px">
      <div class="card" style="border:1px dashed #e5e7eb"><canvas id="liveChart" height="200"></canvas></div>
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ultimele voturi</h3>
        <table id="tblRecent"><thead><tr><th>Timp</th><th>Votant</th><th>Punct</th><th>Op»õiune</th><th>Pondere</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <h3>4) Agenda & Sesiune</h3>
    <div class="row">
      <button class="btn" id="btnSaveAgendaFS">üíæ SalveazƒÉ ordinea de zi √Æn Firestore</button>
      <button class="btn secondary" id="btnLoadAgendaFS">üì• √éncarcƒÉ ordinea de zi din Firestore</button>
      <button class="btn red" id="btnCloseSession">üîí √énchide sesiunea (blocheazƒÉ voturi)</button>
    </div>
    <div class="small muted">Ac»õiunile de mai sus scriu/citesc din <code>meetings/{YYYY-MM-DD}</code>. Disponibile √Æn <b>PROD</b>.</div>

    <h3>5) Export rezultate</h3>
    <div class="row">
      <button class="btn secondary" id="btnExportJSON">Export JSON (detaliat)</button>
      <button class="btn secondary" id="btnExportCSV">Export CSV (detaliat)</button>
      <button class="btn secondary" id="btnExportPDF">Export PDF (detaliat)</button>
      <span class="small muted">Include op»õiunile pe fiecare punct + pondere + timestamp.</span>
    </div>
  </section>

  <!-- Voter -->
  <section class="card hidden" id="secVoter">
    <h2>Vot AGA</h2>
    <div class="grid cols-2">
      <div class="chip">Token: <b id="voterToken">‚Äî</b></div>
      <div class="chip">Pondere: <b id="voterWeight">1</b></div>
    </div>
    <p class="small muted">Alege»õi DA / NU / Ab»õinere pentru fiecare punct. Trimiterea e anonimƒÉ (hash de token).</p>
    <div id="voterAgenda"></div>
    <div class="row" style="margin-top:10px"><button class="btn green" id="btnSubmitVote">Trimite votul</button></div>
    <div id="voterThanks" class="hidden" style="margin-top:10px"><span class="small" style="color:var(--green);font-weight:800">Vot transmis. Mul»õumim!</span></div>
  </section>

  <footer class="card">
    <div class="small muted">Sincronizare activƒÉ ‚Äì Firestore DestineAGA (live) ‚Ä¢ <span id="footerEnv">TEST</span></div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  const $ = sel => document.querySelector(sel);
  const fmt2 = n => String(n).padStart(2,'0');
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const db64 = s => decodeURIComponent(escape(atob(s)));
  const ts = () => new Date().toLocaleString();

  $('#buildTs').textContent = ts();

  // ===== ENV (default TEST, toggle-able)
  let ENV = localStorage.getItem('aga_env') || 'TEST';
  function paintEnv(){ $('#envBadge').textContent = ENV; $('#footerEnv').textContent = ENV; localStorage.setItem('aga_env', ENV); }
  paintEnv();
  $('#btnToggleEnv').addEventListener('click', ()=>{ ENV = (ENV==='TEST'?'PROD':'TEST'); paintEnv(); alert('Mod setat pe: '+ENV); });

  // ===== Project & Password
  const PROJECT_NAME = 'destineaga';
  const ORG_PASSWORD = 'DESTINE2025';
  $('#projectName').textContent = PROJECT_NAME;

  // ===== Firebase (modular)
  let firebaseApp, db, fs_mod;
  async function ensureFirebase(){
    if(firebaseApp) return;
    const fb = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    fs_mod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDbVELVBtmoS1m0761QQ2kI5Cvsjc4cjwc",
      authDomain: "destineaga.firebaseapp.com",
      projectId: "destineaga",
      storageBucket: "destineaga.firebasestorage.app",
      messagingSenderId: "997907169795",
      appId: "1:997907169795:web:e06e62d522a13b01e48436",
      measurementId: "G-CS7C7LQVD5"
    };
    try{
      firebaseApp = fb.initializeApp(FIREBASE_CONFIG);
      db = fs_mod.getFirestore(firebaseApp);
      $('#syncStatus').textContent = 'online';
    }catch(e){
      console.warn('Nu s-a putut ini»õializa Firebase:', e);
      $('#syncStatus').textContent = 'offline';
    }
  }

  // ===== Meeting key (YYYY-MM-DD)
  const meetingKey = new Date().toISOString().slice(0,10);
  $('#meetingKey').textContent = meetingKey;

  // ===== Routing
  const url = new URL(location.href);
  const token = url.searchParams.get('t');
  if(token) enterVoter(token);
  else { $('#secGate').classList.remove('hidden'); $('#roleBadge').textContent = 'Gateway'; }

  // Sample voter
  $('#btnSampleVoter').addEventListener('click', ()=>{ const demo = b64('John Doe|10|'); location.href = location.pathname + '?t=' + demo; });

  // Organizer login
  $('#btnOrgLogin').addEventListener('click', ()=>{
    const pass = $('#orgPass').value.trim();
    if(pass !== ORG_PASSWORD){ alert('ParolƒÉ incorectƒÉ'); return; }
    $('#secGate').classList.add('hidden'); $('#secOrganizer').classList.remove('hidden'); $('#roleBadge').textContent = 'Organizator';
    startOrganizer();
  });

  // ===== State
  const state = { shareholders:[], agenda:[], links:[], chart:null, sessionClosed:false, presentSet:new Set() };

  // ===== CSV Parser (acceptƒÉ Nume,Actiuni,Telefon,Email,ProcurƒÉPentru / ProcuraPentru)
  function parseShareholdersCSV(text){
    const rows = text.split(/\r?\n/).filter(r=>r.trim().length>0);
    if(rows.length<=1) return [];
    const header = rows[0].split(',').map(s=>s.trim());
    function colIndex(names){ // acceptƒÉ variante
      let idx=-1;
      for(const n of names){ idx = header.findIndex(h => h.toLowerCase()===n.toLowerCase()); if(idx!==-1) break; }
      return idx;
    }
    const iN = colIndex(['Nume']);
    const iA = colIndex(['Actiuni','Ac»õiuni','Actiunii']);
    const iT = colIndex(['Telefon']);
    const iE = colIndex(['Email','E-mail']);
    const iP = colIndex(['ProcurƒÉPentru','ProcuraPentru','Procura pentru','ProcurƒÉ pentru']);

    const out = [];
    for(let i=1;i<rows.length;i++){
      const parts = rows[i].split(','); if(parts.length===1 && parts[0].trim()==='') continue;
      const nume = (parts[iN]||'').trim();
      if(!nume) continue;
      const actiuni = Number((parts[iA]||'1').trim()||'1');
      const telefon = (parts[iT]||'').trim();
      const email = (parts[iE]||'').trim();
      const procuraPentru = (parts[iP]||'').trim();
      out.push({ nume, actiuni, telefon, email, procuraPentru });
    }
    return out;
  }

  // ===== UI renderers
  function renderShareholders(){
    const tb = $('#tblShareholders tbody'); tb.innerHTML='';
    state.shareholders.forEach((s,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${s.nume}</td><td>${s.actiuni}</td><td>${s.telefon||''}</td><td>${s.email||''}</td><td>${s.procuraPentru||''}</td>`;
      tb.appendChild(tr);
    });
    $('#kTotalSh').textContent = state.shareholders.length;
  }
  function renderAgenda(){
    const tb = $('#tblAgenda tbody'); tb.innerHTML='';
    state.agenda.forEach((p,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${p.id}</td><td>${p.title}</td>`;
      tb.appendChild(tr);
    });
  }
  function renderLinks(){
    const tb = $('#tblLinks tbody'); tb.innerHTML='';
    state.links.forEach((l,i)=>{
      const tr = document.createElement('tr');
      const idCopy = 'copy_'+i;
      const msg = encodeURIComponent(`BunƒÉ ziua!\nAve»õi acces la votul online pentru AGA Destine Holding (${meetingKey}).\nLinkul dumneavoastrƒÉ unic: ${l.url}\nVƒÉ rugƒÉm sƒÉ vota»õi p√¢nƒÉ la √Ænchiderea sesiunii.`);
      const wa = `https://wa.me/${(l.telefon||'').replace(/[^0-9]/g,'')}?text=${msg}`;
      const mail = `mailto:${encodeURIComponent(l.email||'')}`+`?subject=${encodeURIComponent('Link vot AGA Destine Holding')}&body=${msg}`;
      tr.innerHTML = `<td>${i+1}</td><td>${l.nume}</td><td class="small"><a href="${l.url}" target="_blank">${l.url}</a></td>
        <td><a class="btn secondary" href="${wa}" target="_blank">WhatsApp</a></td>
        <td><a class="btn secondary" href="${mail}">Email</a></td>
        <td><button class="btn secondary" id="${idCopy}">Copy</button></td>`;
      tb.appendChild(tr);
      setTimeout(()=>{ const b=document.getElementById(idCopy); if(b){ b.onclick=async()=>{ await navigator.clipboard.writeText(l.url); b.textContent='Copied'; setTimeout(()=>b.textContent='Copy',1200); }; } },0);
    });
  }

  // ===== Imports
  $('#fileShareholders').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    state.shareholders = parseShareholdersCSV(text);
    renderShareholders();
  });
  $('#fileAgenda').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{ state.agenda = JSON.parse(await file.text()); renderAgenda(); }catch{ alert('JSON invalid'); }
  });
  $('#btnLoadDemos').addEventListener('click', ()=>{
    state.shareholders = [
      {nume:'Popescu Ion', actiuni:120, telefon:'', email:'ion@ex.ro', procuraPentru:''},
      {nume:'Ionescu Maria', actiuni:80,  telefon:'', email:'maria@ex.ro', procuraPentru:''},
      {nume:'Vasilescu Dan', actiuni:50,  telefon:'', email:'dan@ex.ro', procuraPentru:''}
    ];
    state.agenda = [
      {id:'p1', title:'Aprobarea situa»õiilor financiare pe anul precedent'},
      {id:'p2', title:'Bugetul pentru exerci»õiul curent'},
      {id:'p3', title:'Numirea auditorului financiar'}
    ];
    renderShareholders(); renderAgenda();
  });
  $('#btnClearAll').addEventListener('click', ()=>{
    state.shareholders=[]; state.agenda=[]; state.links=[];
    renderShareholders(); renderAgenda(); renderLinks();
  });

  // ===== Link generation
  $('#btnGenerateLinks').addEventListener('click', ()=>{
    if(state.shareholders.length===0){ alert('Importa»õi ac»õionari.'); return; }
    const base = location.origin + location.pathname;
    state.links = state.shareholders.map(s=>{
      const token = b64([s.nume, s.actiuni, s.procuraPentru||''].join('|'));
      const url = `${base}?t=${encodeURIComponent(token)}`;
      return { nume:s.nume, telefon:s.telefon, email:s.email, url };
    });
    renderLinks();
  });
  $('#btnCopyAll').addEventListener('click', async ()=>{
    const lines = state.links.map((l,i)=>`${i+1}. ${l.nume} ‚Äî ${l.url}`).join('\n');
    await navigator.clipboard.writeText(lines); alert('Lista copiatƒÉ.');
  });
  $('#btnExportLinksCSV').addEventListener('click', ()=>{
    const rows = [['Nume','Telefon','Email','Link']];
    state.links.forEach(l=>rows.push([l.nume, l.telefon||'', l.email||'', l.url]));
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadBlob(csv, `linkuri_${meetingKey}.csv`, 'text/csv');
  });

  // ===== Live Organizer
  async function startOrganizer(){
    await ensureFirebase();
    // Timer
    const start = Date.now();
    setInterval(()=>{ const sec=Math.floor((Date.now()-start)/1000); $('#kTimer').textContent=`${fmt2(Math.floor(sec/60))}:${fmt2(sec%60)}`; },1000);
    // Chart
    const ctx=document.getElementById('liveChart'); const chart=new Chart(ctx, {type:'doughnut', data:{labels:['DA','NU','Ab»õinere'], datasets:[{data:[0,0,0]}]}, options:{responsive:true}});
    state.chart = chart;

    if(!db) return;

    // Load meeting doc (agenda + closed)
    try{
      const { doc, getDoc, onSnapshot, collection } = fs_mod;
      const mref = doc(db,'meetings',meetingKey);
      const msnap = await getDoc(mref);
      if(msnap.exists()){
        const d = msnap.data();
        state.sessionClosed = !!d.closed;
        $('#kClosed').textContent = state.sessionClosed ? '√énchisƒÉ' : 'DeschisƒÉ';
        if(Array.isArray(d.agenda)){ state.agenda = d.agenda; renderAgenda(); }
      }
      // Presence subscribe
      const pref = collection(db,'presence',meetingKey,'visitors');
      onSnapshot(pref,(snap)=>{
        state.presentSet = new Set();
        snap.forEach(doc=> state.presentSet.add(doc.id));
        $('#kPresent').textContent = state.presentSet.size;
      });
      // Votes subscribe
      const vref = collection(db,'votes',meetingKey,'submissions');
      onSnapshot(vref,(snap)=>{
        let wDA=0,wNU=0,wAB=0; const recent=[];
        snap.docChanges().forEach(ch=>{ if(ch.type==='added') ping(); });
        snap.forEach(doc=>{
          const v=doc.data(); const items=v.items||{};
          Object.keys(items).forEach(pid=>{
            const it=items[pid]; const w=Number(it.weight||1);
            if(it.choice==='DA') wDA+=w; else if(it.choice==='NU') wNU+=w; else wAB+=w;
            recent.push({ t:new Date(v.createdAt||Date.now()).toLocaleTimeString(), voter:v.anon||doc.id, pid, choice:it.choice, w });
          });
        });
        chart.data.datasets[0].data=[wDA,wNU,wAB]; chart.update();
        $('#kCast').textContent = recent.length;
        const tb=$('#tblRecent tbody'); tb.innerHTML='';
        recent.slice(-15).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.t}</td><td>${r.voter}</td><td>${r.pid}</td><td>${r.choice}</td><td>${r.w}</td>`; tb.appendChild(tr); });
      });
    }catch(e){ console.warn('Live subscribe error:', e); }
  }

  // ===== Agenda & Session buttons (PROD only)
  $('#btnSaveAgendaFS').addEventListener('click', async ()=>{
    if(ENV!=='PROD'){ alert('Disponibil doar √Æn PROD. Comuta»õi modul.'); return; }
    await ensureFirebase(); if(!db){ alert('Firestore indisponibil.'); return; }
    try{
      const { doc, setDoc, serverTimestamp } = fs_mod;
      const mref = doc(db,'meetings',meetingKey);
      await setDoc(mref, { agenda: state.agenda, updatedAt: serverTimestamp(), closed: false }, { merge:true });
      alert('‚úÖ Ordinea de zi a fost salvatƒÉ √Æn Firestore.');
    }catch(e){ alert('Eroare la salvare agenda.'); }
  });
  $('#btnLoadAgendaFS').addEventListener('click', async ()=>{
    if(ENV!=='PROD'){ alert('Disponibil doar √Æn PROD. Comuta»õi modul.'); return; }
    await ensureFirebase(); if(!db){ alert('Firestore indisponibil.'); return; }
    try{
      const { doc, getDoc } = fs_mod;
      const mref = doc(db,'meetings',meetingKey);
      const s = await getDoc(mref);
      if(s.exists() && Array.isArray(s.data().agenda)){ state.agenda = s.data().agenda; renderAgenda(); alert('Agenda √ÆncƒÉrcatƒÉ din Firestore.'); }
      else alert('Nu existƒÉ agenda salvatƒÉ pentru aceastƒÉ datƒÉ.');
    }catch(e){ alert('Eroare la √ÆncƒÉrcare agenda.'); }
  });
  $('#btnCloseSession').addEventListener('click', async ()=>{
    if(!confirm('Sigur √Ænchizi sesiunea? DupƒÉ √Ænchidere nu se mai pot trimite voturi.')) return;
    await ensureFirebase(); if(!db){ alert('Firestore indisponibil.'); return; }
    if(ENV!=='PROD'){ alert('Disponibil doar √Æn PROD.'); return; }
    try{
      const { doc, setDoc, serverTimestamp } = fs_mod;
      const mref = doc(db,'meetings',meetingKey);
      await setDoc(mref, { closed: true, closedAt: serverTimestamp() }, { merge:true });
      state.sessionClosed = true; $('#kClosed').textContent = '√énchisƒÉ';
      alert('üîí Sesiune √ÆnchisƒÉ.');
    }catch(e){ alert('Eroare la √Ænchidere sesiune.'); }
  });

  // ===== Exports
  $('#btnExportJSON').addEventListener('click', async ()=>{
    const data = await collectVotesDetailed();
    downloadBlob(JSON.stringify(data,null,2), `voturi_${meetingKey}.json`, 'application/json');
  });
  $('#btnExportCSV').addEventListener('click', async ()=>{
    const data = await collectVotesDetailed();
    const rows=[['voter','pid','choice','weight','createdAt']];
    data.rows.forEach(r=>rows.push([r.voter,r.pid,r.choice,r.weight,r.createdAt]));
    const csv=rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
    downloadBlob(csv, `voturi_${meetingKey}.csv`, 'text/csv');
  });
  $('#btnExportPDF').addEventListener('click', async ()=>{
    const data = await collectVotesDetailed();
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.setFontSize(12); doc.text(`Raport voturi ‚Äî ${meetingKey}`,14,16);
    const body = data.rows.map(r=>[r.voter,r.pid,r.choice,String(r.weight), new Date(r.createdAt).toLocaleString()]);
    doc.autoTable({ head:[['Votant','Punct','Op»õiune','Pondere','Creat la']], body, startY:22 });
    doc.save(`voturi_${meetingKey}.pdf`);
  });

  async function collectVotesDetailed(){
    await ensureFirebase(); const out={rows:[]}; if(!db) return out;
    const { collection, getDocs } = fs_mod;
    const vref = collection(db,'votes',meetingKey,'submissions');
    const snap = await getDocs(vref);
    snap.forEach(d=>{
      const v=d.data(); const items=v.items||{};
      Object.keys(items).forEach(pid=>{
        const it=items[pid];
        out.rows.push({ voter:v.anon||d.id, pid, choice:it.choice, weight:Number(it.weight||1), createdAt: v.createdAt||Date.now() });
      });
    });
    return out;
  }

  // ===== Voter view
  async function enterVoter(token){
    $('#secGate').classList.add('hidden');
    $('#secVoter').classList.remove('hidden');
    $('#roleBadge').textContent='Votant';
    $('#voterToken').textContent = token.slice(0,10)+'‚Ä¶';

    // decode token: Nume|Actiuni|ProcuraPentru
    let name=''; let weight=1; let proc='';
    try{ const [n,a,p] = db64(token).split('|'); name=n||''; weight=Number(a||1); proc=p||''; }catch{}
    $('#voterWeight').textContent = weight;

    await ensureFirebase();

    // get meeting status + agenda from Firestore if possible
    let agenda=[{id:'p1',title:'Aprobarea situa»õiilor financiare pe anul precedent'},{id:'p2',title:'Bugetul pentru exerci»õiul curent'},{id:'p3',title:'Numirea auditorului financiar'}];
    let closed = false;
    if(db){
      try{
        const { doc, getDoc, setDoc, serverTimestamp } = fs_mod;
        const mref = doc(db,'meetings',meetingKey);
        const ms = await getDoc(mref);
        if(ms.exists()){ const md=ms.data(); if(Array.isArray(md.agenda)) agenda=md.agenda; closed = !!md.closed; }
        // presence write (PROD only)
        if(ENV==='PROD'){
          const pref = doc(db,'presence',meetingKey,'visitors','h_'+token.slice(0,24));
          await setDoc(pref, { at: serverTimestamp() }, { merge:true });
        }
      }catch(e){}
    }

    const root = $('#voterAgenda'); root.innerHTML='';
    agenda.forEach((p,i)=>{
      const box = document.createElement('div'); box.className='card'; box.style.border='1px dashed #e5e7eb';
      box.innerHTML = `<div><b>Punct ${i+1}.</b> ${p.title}</div>
        <div class='row' style='margin-top:8px'>
          <label><input type='radio' name='v_${p.id}' value='DA'> DA</label>
          <label><input type='radio' name='v_${p.id}' value='NU'> NU</label>
          <label><input type='radio' name='v_${p.id}' value='AB'> Ab»õinere</label>
        </div>`;
      root.appendChild(box);
    });

    const submitBtn = $('#btnSubmitVote');
    if(closed){
      submitBtn.disabled = true; submitBtn.textContent='Sesiune √ÆnchisƒÉ'; submitBtn.classList.add('red');
    }

    submitBtn.onclick = async ()=>{
      if(closed){ alert('Sesiune √ÆnchisƒÉ.'); return; }
      const choices={}; agenda.forEach(p=>{ const sel=document.querySelector(`input[name="v_${p.id}}"]:checked`); });
      // fix selector typo:
      agenda.forEach(p=>{ const sel=document.querySelector(`input[name="v_${p.id}"]:checked`); choices[p.id]= sel?sel.value:'AB'; });
      const payload = { meeting:meetingKey, createdAt:Date.now(), anon:'h_'+token.slice(0,10), items:Object.fromEntries(Object.keys(choices).map(pid=>[pid,{choice:choices[pid],weight:weight}])) };
      if(ENV==='TEST'){ $('#voterThanks').classList.remove('hidden'); submitBtn.disabled=true; alert('Mod TEST: votul NU a fost scris √Æn Firestore.'); return; }
      if(!db){ alert('Config Firestore indisponibil.'); return; }
      try{
        const { doc, setDoc, serverTimestamp } = fs_mod;
        const vref=doc(db,'votes',meetingKey,'submissions','h_'+token.slice(0,24));
        await setDoc(vref, {...payload, serverAt: serverTimestamp(), name: name?name:undefined, proxyFor: proc||undefined }, {merge:true});
      }catch(e){ alert('Eroare la trimiterea votului. √éncerca»õi din nou.'); return; }
      $('#voterThanks').classList.remove('hidden'); submitBtn.disabled=true;
    };
  }

  // ===== Utils
  function downloadBlob(content, filename, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }
  function ping(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.03; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop(); ctx.close();},120); }catch{} }
</script>
</body>
</html>
