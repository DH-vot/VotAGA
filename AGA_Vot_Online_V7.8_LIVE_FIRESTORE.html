<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AGA Destine Holding â€“ V7.8 LIVE (Firestore)</title>
<style>
:root{--blue:#0b3d91;--blue2:#072f73;--bg:#f7f9fc;--card:#fff;--line:#e8ecf2}
*{box-sizing:border-box} body{font-family:'Segoe UI',Arial,sans-serif;margin:0;background:var(--bg);color:#1d2530}
header{text-align:center;background:#fff;border-bottom:1px solid #eaeaea;padding:18px 10px}
header h1{color:#0b3d91;margin:8px 0 4px;font-size:22px} header p{margin:0;color:#55606f;font-size:14px}
.container{max-width:1120px;margin:18px auto;background:var(--card);padding:18px;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
.row{display:flex;gap:10px;flex-wrap:wrap}.row>div{flex:1 1 260px}
.info{background:#eaf1ff;padding:10px;border-left:4px solid #0b3d91;border-radius:8px;margin-bottom:14px}
input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #d7dbe3;font-size:15px;background:#fff}
button{padding:10px 14px;border-radius:10px;border:none;background:#0b3d91;color:#fff;font-weight:600;cursor:pointer}
button:hover{background:#072f73} .muted{color:#6b7280;font-size:13px}
table{width:100%;border-collapse:collapse;margin:12px 0}
th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top} th{background:#eef3ff}
.card{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;background:#fff}
.hr{height:1px;background:#eceff6;border:0;margin:14px 0} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef3ff;color:#0b3d91;font-weight:600}
.success{color:#065f46} footer{text-align:center;color:#6b7280;font-size:12px;padding:16px}
.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef3ff;margin-left:6px}
.badge.green{background:#e8faef;color:#166534} .badge.gray{background:#f1f5f9;color:#334155}
small.hint{display:block;color:#6b7280;margin-top:6px}
</style>
</head>
<body>
<header>
  <svg viewBox="0 0 800 160" xmlns="http://www.w3.org/2000/svg" width="240" height="48" aria-label="Destine Holding">
    <rect width="800" height="160" fill="#fff"/>
    <text x="50%" y="56%" text-anchor="middle" font-family="Segoe UI, Arial" font-size="54" font-weight="700" fill="#0b3d91">Destine Holding S.A.</text>
  </svg>
  <h1>Program de vot online â€“ Destine Holding S.A.</h1>
  <p>Instrument digital pentru gestionarea prezenÈ›ei È™i a voturilor acÈ›ionarilor</p>
  <p class="muted">Versiune <b>V7.8 LIVE (Firestore)</b> â€“ proiect <span class="mono">destineaga</span></p>
</header>

<!-- Gateway -->
<div class="container" id="gateway">
  <div class="info"><b>Acces votant</b>: dacÄƒ linkul conÈ›ine <span class="mono">?sid=...&t=...</span>, intraÈ›i direct Ã®n modul Votant.</div>
  <div class="card">
    <div class="row">
      <div><label>Mod organizator â€“ parolÄƒ</label><input id="parolaOrganizator" type="password" placeholder="Parola (implicit: DH2026)"></div>
      <div style="flex:0 0 auto;align-self:end"><button id="btnOrganizator">IntrÄƒ ca organizator</button></div>
      <div style="flex:0 0 auto;align-self:end"><button id="btnSchimbaParola">ğŸ”‘ SchimbÄƒ parola</button></div>
    </div>
    <p class="muted">FolosiÈ›i aceeaÈ™i sesiune (<span class="mono">sid</span>) pe toate dispozitivele.</p>
  </div>
</div>

<!-- Organizator -->
<div class="container" id="organizator" style="display:none">
  <h2>âš™ï¸ SetÄƒri AGA <span class="pill">LIVE</span></h2>
  <div class="row">
    <div><label>Companie</label><input id="companie" value="Destine Holding S.A."></div>
    <div><label>Data È™edinÈ›ei</label><input id="dataSedintei" value=""></div>
    <div><label>ID sesiune (ex: AGA_2025_DH)</label><input id="sessionId" value="AGA_2025_DH"><div class="muted">Folosit Ã®n Firestore È™i Ã®n linkuri (<span class="mono">sid=...</span>).</div></div>
  </div>

  <div class="row">
    <div><label>ğŸ•’ Ãnceput vot</label><input id="voteStart" type="datetime-local"><small class="hint">VotanÈ›ii pot intra Ã®nainte, dar nu pot trimite votul pÃ¢nÄƒ la start.</small></div>
    <div><label>ğŸ•’ SfÃ¢rÈ™it vot</label><input id="voteEnd" type="datetime-local"><small class="hint">DupÄƒ acest moment, trimiterea votului este blocatÄƒ.</small></div>
  </div>

  <div class="hr"></div>

  <h3>ğŸ‘¤ AcÈ›ionari & PrezenÈ›Äƒ</h3>
  <div class="row">
    <button id="btnImportCSV">ğŸ“¥ ImportÄƒ acÈ›ionari (CSV)</button>
    <button id="btnExportCSV">ğŸ“¤ ExportÄƒ acÈ›ionari</button>
    <button id="btnGenTok">ğŸ”— GenereazÄƒ tokenuri</button>
    <button id="btnPresence">ğŸ‘ï¸ AfiÈ™eazÄƒ prezenÈ›a</button>
    <button id="btnPresencePDF">ğŸ§¾ ExportÄƒ raport prezenÈ›Äƒ (PDF)</button>
    <button id="btnAddCorr">âœ‰ï¸ AdaugÄƒ vot prin corespondenÈ›Äƒ</button>
  </div>
  <table>
    <thead><tr>
      <th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>Telefon</th><th>Email</th><th>ProcurÄƒPentru</th>
      <th>Tip</th><th>InstrucÈ›iuniVot</th><th>Token</th><th>Link votant</th><th>Status vot</th>
    </tr></thead>
    <tbody id="listaActionari"></tbody>
  </table>
  <div id="rezumatPrezenta" class="muted"></div>

  <div class="hr"></div>

  <h3>ğŸ—“ï¸ Ordinea de zi</h3>
  <div class="row">
    <button id="btnImportODZ">ğŸ“¥ ImportÄƒ Ordinea de zi (CSV)</button>
    <button id="btnExportODZ">ğŸ“¤ ExportÄƒ Ordinea de zi</button>
    <button id="btnAdaugaPunct">â• AdaugÄƒ punct manual</button>
  </div>
  <div id="ordineContainer"></div>

  <div class="hr"></div>
  <div class="row">
    <button id="btnPublish">ğŸ“¡ PublicÄƒ Ã®n Firestore (acÈ›ionari + ordinea de zi + setÄƒri)</button>
    <button id="btnConnectLive">ğŸ”„ ReÃ®mprospÄƒtare voturi (live)</button>
    <button id="btnPDF">ğŸ–¨ï¸ ExportÄƒ raport voturi (PDF)</button>
  </div>

  <div class="card">
    <h3>ğŸ“Š Rezultate live</h3>
    <div id="rezumatVoturi" class="muted"></div>
    <table>
      <thead><tr><th>#</th><th>Punct</th><th>DA</th><th>NU</th><th>AbÈ›ineri</th><th>% DA</th></tr></thead>
      <tbody id="rezultate"></tbody>
    </table>
  </div>

  <div class="card" id="presencePanel" style="display:none">
    <h3>ğŸ‘ï¸ PrezenÈ›Äƒ</h3>
    <div id="presenceStats" class="muted"></div>
    <table>
      <thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>Tip</th><th>Status</th><th>ObservaÈ›ii</th></tr></thead>
      <tbody id="presenceTable"></tbody>
    </table>
  </div>
</div>

<!-- Votant -->
<div class="container" id="votant" style="display:none">
  <h2>ğŸ—³ï¸ Votant</h2>
  <p id="helloVoter" class="muted"></p>
  <div id="intrebari"></div>
  <div class="hr"></div>
  <button id="btnTrimiteVot">Trimite votul</button>
  <p id="statusVot" class="success"></p>
</div>

<footer>Destine Holding S.A. Â© 2025 â€” PlatformÄƒ AGA V7.8 LIVE (Firestore)</footer>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
(function(){
'use strict';
/* ===== Utils ===== */
const $=id=>document.getElementById(id);
const qsa=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
const escapeHTML=s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const splitCSV=line=>{let out=[],cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c=='"'){q=!q;continue;}if(c==","&&!q){out.push(cur);cur='';continue;}cur+=c;}out.push(cur);return out.map(s=>(s||'').trim());};
const escapeCSV=s=>(s==null)?'':(/[,"\n]/.test(String(s))?('"'+String(s).replace(/"/g,'""')+'"'):String(s));
const pct=(x,tot)=>tot?((x/tot)*100).toFixed(2)+'%':'0.00%';
const downloadBlob=(content,type,name)=>{const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(u),800);};
const genTok=seed=>{let h=0;seed=String(seed||'');for(let i=0;i<seed.length;i++){h=(h*31+seed.charCodeAt(i))|0;}h=Math.abs(h);return h.toString(36).slice(0,8)};
const parseInstr=(s)=>{const out={}; if(!s) return out; s.split(';').forEach(p=>{const m=p.split(':'); if(m.length===2){out[String(m[0]).trim()]=String(m[1]).trim().toUpperCase();}}); return out;};

/* ===== State ===== */
let actionari=[], ordineZi=[];
let parolaCorecta = localStorage.getItem('parolaAGA') || 'DH2026';
let votesUnsub=null; // listener live
let voterCtx=null;   // {sid, token, shareholder}
let votedTokens=new Set(); // pentru status â€a votatâ€
let lastVotesCache=[];

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDbVELVBtmoS1m0761QQ2kI5Cvsjc4cjwc",
  authDomain: "destineaga.firebaseapp.com",
  projectId: "destineaga",
  storageBucket: "destineaga.firebasestorage.app",
  messagingSenderId: "997907169795",
  appId: "1:997907169795:web:e06e62d522a13b01e48436",
  measurementId: "G-CS7C7LQVD5"
};
const app = firebase.initializeApp(firebaseConfig);
const db  = firebase.firestore();

/* ===== Router (token) ===== */
const url = new URL(location.href);
const sidURL = url.searchParams.get('sid');
const tokURL = url.searchParams.get('t');
if (sidURL && tokURL){
  $('gateway').style.display='none';
  $('votant').style.display='block';
  initVoter(sidURL, tokURL);
}

/* ===== Organizator auth ===== */
$('btnOrganizator').addEventListener('click', ()=>{
  const p=$('parolaOrganizator').value.trim();
  if(!p) return alert('IntroduceÈ›i parola!');
  if(p===parolaCorecta){ $('gateway').style.display='none'; $('organizator').style.display='block'; }
  else alert('ParolÄƒ incorectÄƒ!');
});
$('btnSchimbaParola').addEventListener('click', ()=>{
  const n=prompt('IntroduceÈ›i noua parolÄƒ:');
  if(n&&n.trim()!==''){ parolaCorecta=n.trim(); localStorage.setItem('parolaAGA',parolaCorecta); alert('Parola a fost schimbatÄƒ!'); }
});

/* ===== AcÈ›ionari (CSV: Nume,Actiuni,Telefon,Email,ProcurÄƒPentru,Tip,InstrucÈ›iuniVot,Token[opÈ›ional]) ===== */
$('btnImportCSV').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='.csv';
  i.onchange=e=>{
    const f=e.target.files[0]; const r=new FileReader();
    r.onload=ev=>{
      const rows=ev.target.result.split(/\r?\n/).filter(x=>x.trim());
      actionari=[];
      for(let k=1;k<rows.length;k++){
        const c=splitCSV(rows[k]); if(!c[0]) continue;
        actionari.push({nume:c[0],actiuni:parseInt(c[1]||'0',10)||0,tel:c[2]||'',email:c[3]||'',procura:c[4]||'',tip:(c[5]||'').trim(),instructiuni:(c[6]||'').trim(),token:(c[7]||'').trim()});
      }
      renderActionari();
    };
    r.readAsText(f);
  };
  i.click();
});
$('btnExportCSV').addEventListener('click', ()=>{
  let csv='Nume,Actiuni,Telefon,Email,ProcurÄƒPentru,Tip,InstrucÈ›iuniVot,Token\n';
  actionari.forEach(a=>{ csv+=`${escapeCSV(a.nume)},${a.actiuni},${escapeCSV(a.tel||'')},${escapeCSV(a.email||'')},${escapeCSV(a.procura||'')},${escapeCSV(a.tip||'')},${escapeCSV(a.instructiuni||'')},${escapeCSV(a.token||'')}\n`; });
  downloadBlob(csv,'text/csv;charset=utf-8;','actionari_export.csv');
});
$('btnGenTok').addEventListener('click', ()=>{
  actionari=actionari.map(a=>{ if(!a.token||a.token.trim()===''){ a.token=genTok(`${a.nume||''}|${a.email||''}|${a.tel||''}`);} return a; });
  renderActionari(); alert('Tokenurile au fost generate.');
});

function renderActionari(votesMap=null){
  const tb=$('listaActionari'); tb.innerHTML='';
  const sid=$('sessionId').value.trim()||'AGA_2025_DH';
  const base=location.href.replace(/[?#].*$/,'');
  const total = actionari.reduce((s,a)=>s+(Number(a.actiuni)||0),0);
  let prez=0, cntVot=0;

  actionari.forEach((a,i)=>{
    const link=`${base}?sid=${encodeURIComponent(sid)}&t=${encodeURIComponent(a.token||'')}`;
    const voted = votesMap ? votesMap.has(a.token) : votedTokens.has(a.token);
    const votedBadge = voted ? '<span class="badge green">a votat</span>' :
      (a.tip?.toLowerCase()==='corespondenta' && a.instructiuni ? '<span class="badge gray">corespondenta</span>' : '<span class="badge gray">neÃ®nregistrat</span>');
    if (voted || (a.tip?.toLowerCase()==='corespondenta' && a.instructiuni)) prez += Number(a.actiuni)||0;

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${escapeHTML(a.nume)}</td><td>${a.actiuni}</td>
      <td>${escapeHTML(a.tel||'')}</td><td>${escapeHTML(a.email||'')}</td>
      <td>${escapeHTML(a.procura||'')}</td><td>${escapeHTML(a.tip||'')}</td>
      <td class="mono">${escapeHTML(a.instructiuni||'')}</td>
      <td class="mono">${escapeHTML(a.token||'')}</td>
      <td><button data-copy="${encodeURIComponent(link)}">CopiazÄƒ link</button></td>
      <td>${votedBadge}</td>`;
    tb.appendChild(tr);
    if(voted) cntVot++;
  });
  tb.querySelectorAll('button[data-copy]').forEach(b=> b.addEventListener('click',ev=>{
    const u=decodeURIComponent(ev.target.getAttribute('data-copy')); navigator.clipboard.writeText(u).then(()=>alert('Link copiat:\n'+u));
  }));
  $('rezumatPrezenta').innerHTML = `Total acÈ›iuni: <b>${total}</b> â€¢ Prezente (incl. corespondenÈ›Äƒ): <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ Au votat: <b>${cntVot}</b> / <b>${actionari.length}</b>`;
}

/* ===== Ordinea de zi ===== */
$('btnAdaugaPunct').addEventListener('click', ()=> addPunct('','Majoritate simplÄƒ (>50%)','Nu',''));
$('btnImportODZ').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='.csv';
  i.onchange=e=>{
    const f=e.target.files[0]; const r=new FileReader();
    r.onload=ev=>{
      const rows=ev.target.result.split(/\r?\n/).filter(x=>x.trim());
      ordineZi=[]; $('ordineContainer').innerHTML='';
      for(let k=1;k<rows.length;k++){ const c=splitCSV(rows[k]); const titlu=c[0]||''; if(!titlu) continue;
        addPunct(titlu, c[1]||'Majoritate simplÄƒ (>50%)', c[2]||'Nu', c[3]||'');
      }
      alert('Ordinea de zi a fost importatÄƒ.');
    };
    r.readAsText(f);
  };
  i.click();
});
$('btnExportODZ').addEventListener('click', ()=>{
  let csv='Titlu,Majoritate,VotSecret,Observatii\n';
  ordineZi.forEach(o=>{ csv+=`${escapeCSV(o.titlu)},${escapeCSV(o.majoritate)},${escapeCSV(o.votSecret)},${escapeCSV(o.observatii)}\n`; });
  downloadBlob(csv,'text/csv;charset=utf-8;','ordine_zi_export.csv');
});
function addPunct(titlu,majoritate,votSecret,observatii){
  const idx=ordineZi.length;
  const d=document.createElement('div'); d.className='card';
  d.innerHTML=`<div><b>Punct #${idx+1}</b></div>
    <label>Titlu</label><input data-f="titlu" value="${escapeHTML(titlu)}">
    <label>Majoritate</label><input data-f="majoritate" value="${escapeHTML(majoritate)}">
    <label>Vot secret</label><select data-f="votSecret"><option${votSecret==='Nu'?' selected':''}>Nu</option><option${votSecret==='Da'?' selected':''}>Da</option></select>
    <label>ObservaÈ›ii</label><textarea data-f="observatii">${escapeHTML(observatii)}</textarea>`;
  $('ordineContainer').appendChild(d);
  ordineZi.push({titlu,majoritate,votSecret,observatii});
  d.querySelectorAll('[data-f]').forEach(ctrl=> ctrl.addEventListener('input', ()=>{ const f=ctrl.getAttribute('data-f'); ordineZi[idx][f]=ctrl.value; }));
}

/* ===== Publicare Firestore (setÄƒri + consolidare procuri + corespondenta) ===== */
$('btnPublish').addEventListener('click', async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  if(!confirm('PublicaÈ›i acÈ›ionarii, ordinea de zi È™i setÄƒrile Ã®n Firestore pentru sesiunea '+sid+'?')) return;
  try{
    const sessRef=db.collection('sessions').doc(sid);
    // Timpuri (ISO)
    const start = $('voteStart').value ? new Date($('voteStart').value).toISOString() : '';
    const end   = $('voteEnd').value ? new Date($('voteEnd').value).toISOString() : '';
    await sessRef.set({company:$('companie').value,date:$('dataSedintei').value,startTime:start,endTime:end,updated:Date.now()},{merge:true});

    // CurÄƒÈ›are subcolecÈ›ii
    const delAll=async (col)=>{ const snap=await col.get(); if(snap.empty) return; const batch=db.batch(); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); };
    await delAll(sessRef.collection('shareholders'));
    await delAll(sessRef.collection('agenda'));
    await delAll(sessRef.collection('votes'));

    // Tokenuri
    actionari = actionari.map(a=>{ if(!a.token||a.token.trim()===''){ a.token = genTok(`${a.nume||''}|${a.email||''}|${a.tel||''}`);} return a; });

    // Scriere acÈ›ionari (proprii)
    const b1=db.batch();
    actionari.forEach(a=>{
      b1.set(sessRef.collection('shareholders').doc(a.token), {
        token:a.token,nume:a.nume,actiuni:Number(a.actiuni)||0,tel:a.tel||'',email:a.email||'',
        procura:a.procura||'',tip:a.tip||'',instructiuni:a.instructiuni||'',reprezentatDe:''
      },{merge:true});
    });
    await b1.commit();

    // Harta nume -> token
    const shSnap1 = await sessRef.collection('shareholders').get();
    const byName={}; shSnap1.forEach(d=>{ const s=d.data(); byName[(s.nume||'').trim().toLowerCase()] = s.token; });

    // MarcheazÄƒ reprezentatDe
    const bMark=db.batch();
    shSnap1.forEach(d=>{
      const s=d.data(); const procura=(s.procura||'').trim(); if(procura){
        const repTok = byName[procura.toLowerCase()]; if(repTok){ bMark.set(sessRef.collection('shareholders').doc(s.token), {reprezentatDe: procura}, {merge:true}); }
      }
    });
    await bMark.commit();

    // Consolidare acÈ›iuni reprezentate
    const shSnap2 = await sessRef.collection('shareholders').get();
    const details={}; shSnap2.forEach(d=>{ const s=d.data(); details[s.token]={name:s.nume,own:Number(s.actiuni)||0,represented:0}; });
    shSnap2.forEach(d=>{
      const s=d.data(); const repName=(s.procura||'').trim().toLowerCase();
      if(repName){ const repTok = byName[repName]; if(repTok && details[repTok]) details[repTok].represented += Number(s.actiuni)||0; }
    });
    const bCon=db.batch();
    Object.keys(details).forEach(tok=>{
      const t=details[tok];
      bCon.set(sessRef.collection('shareholders').doc(tok), {actiuniProprii:t.own,actiuniReprezentate:t.represented,totalActiuniReprezentate:t.own+t.represented},{merge:true});
    });
    await bCon.commit();

    // PublicÄƒ agenda
    const b2=db.batch();
    ordineZi.forEach((o,idx)=> b2.set(sessRef.collection('agenda').doc(String(idx+1)), {idx:idx+1,titlu:o.titlu,majoritate:o.majoritate,votSecret:o.votSecret,observatii:o.observatii||''}) );
    await b2.commit();

    // ÃnregistreazÄƒ â€corespondentaâ€ ca vot preinserat
    const shSnap3 = await sessRef.collection('shareholders').get();
    const bVotes = db.batch();
    shSnap3.forEach(d=>{
      const s=d.data();
      const isCorr = (String(s.tip||'').toLowerCase()==='corespondenta') && s.instructiuni;
      if(isCorr){
        bVotes.set(sessRef.collection('votes').doc(s.token), {
          voterToken:s.token, voterName:s.nume,
          weight:Number(s.totalActiuniReprezentate || s.actiuniProprii || s.actiuni || 0),
          choices:parseInstr(s.instructiuni), source:'corespondenta', ts: Date.now()
        }, {merge:true});
      }
    });
    await bVotes.commit();

    alert('Publicare reuÈ™itÄƒ (setÄƒri + acÈ›ionari + ordinea de zi + consolidare procuri + corespondenÈ›Äƒ).');
  }catch(e){ console.error(e); alert('Eroare publicare: '+e.message); }
});

/* ===== Live rezultate + status â€a votat / nuâ€ ===== */
$('btnConnectLive').addEventListener('click', ()=> connectLive());
async function connectLive(){
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  if(votesUnsub){ votesUnsub(); votesUnsub=null; }

  const sessRef=db.collection('sessions').doc(sid);
  const [agSnap,shSnap]=await Promise.all([
    sessRef.collection('agenda').orderBy('idx').get(),
    sessRef.collection('shareholders').get()
  ]);

  const agenda=agSnap.docs.map(d=>d.data());
  const shares={}; // token -> {own,total,represented,tip,procura,name}
  shSnap.forEach(d=>{
    const s=d.data();
    shares[s.token]={
      name:s.nume, tip:s.tip||'', procura:s.reprezentatDe||'',
      own:Number(s.actiuniProprii ?? s.actiuni)||0,
      total:Number(s.totalActiuniReprezentate ?? s.actiuni)||0,
      represented:Number(s.actiuniReprezentate||0)
    };
  });

  votesUnsub=sessRef.collection('votes').onSnapshot(snap=>{
    const votes=[]; votedTokens=new Set();
    snap.forEach(d=>{ const v=d.data(); votes.push(v); votedTokens.add(v.voterToken); });
    lastVotesCache=votes;
    renderResults(agenda,shares,votes);
    renderActionari(votedTokens);
  });
  alert('Sincronizare activÄƒ pe sesiunea: '+sid);
}
function renderResults(agenda,shares,votes){
  const tb=$('rezultate'); tb.innerHTML='';
  const tally=agenda.map(()=>({da:0,nu:0,ab:0}));
  votes.forEach(v=>{
    const wt = Number(v.weight) || (shares[v.voterToken]?.total || shares[v.voterToken]?.own || 0);
    const ch=v.choices||{};
    Object.keys(ch).forEach(k=>{
      const idx=parseInt(k,10)-1; if(isNaN(idx)||idx<0||idx>=tally.length) return;
      const val=(ch[k]||'').toUpperCase();
      if(val==='DA') tally[idx].da+=wt;
      else if(val==='NU') tally[idx].nu+=wt;
      else tally[idx].ab+=wt;
    });
  });
  tally.forEach((t,i)=>{
    const total=t.da+t.nu+t.ab;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${escapeHTML(agenda[i].titlu)}</td><td>${t.da}</td><td>${t.nu}</td><td>${t.ab}</td><td>${pct(t.da,total)}</td>`;
    tb.appendChild(tr);
  });
  $('rezumatVoturi').textContent=`Voturi Ã®nregistrate: ${votes.length} â€¢ Puncte: ${agenda.length}`;
}

/* ===== Votant (validare fereastrÄƒ de vot) ===== */
async function initVoter(sid,token){
  try{
    const sessRef=db.collection('sessions').doc(sid);
    const sess=await sessRef.get();
    const cfg=sess.exists? sess.data() : {};
    const now=Date.now();
    const start=cfg.startTime? Date.parse(cfg.startTime): null;
    const end  =cfg.endTime?   Date.parse(cfg.endTime)  : null;

    let sh=await sessRef.collection('shareholders').doc(token).get();
    if(!sh.exists){
      const q=await sessRef.collection('shareholders').where('token','==',token).limit(1).get();
      if(q.empty){ $('helloVoter').textContent='Link invalid sau sesiune indisponibilÄƒ.'; return; }
      sh=q.docs[0];
    }
    const s=sh.data();
    voterCtx={sid,token:s.token,shareholder:s};

    // mesaje perioadÄƒ
    if(start && now<start){ $('helloVoter').innerHTML='Bun venit, <b>'+escapeHTML(s.nume)+'</b> â€” <span class="badge gray">votul nu este Ã®ncÄƒ deschis</span>'; disableVoteUI('Votul se va deschide la: '+new Date(start).toLocaleString()); return; }
    if(end && now>end){ $('helloVoter').innerHTML='Bun venit, <b>'+escapeHTML(s.nume)+'</b> â€” <span class="badge gray">perioada de vot s-a Ã®ncheiat</span>'; disableVoteUI('Perioada de vot s-a Ã®ncheiat la: '+new Date(end).toLocaleString()); return; }

    // reprezentare
    if(s.reprezentatDe){
      $('helloVoter').innerHTML='Bun venit, <b>'+escapeHTML(s.nume)+'</b> â€” <span class="badge gray">vot prin reprezentant: '+escapeHTML(s.reprezentatDe)+'</span>';
      $('intrebari').innerHTML='<div class="card">Mandatul dvs. este Ã®nregistrat ca <b>procurÄƒ</b>. Votul se exprimÄƒ de cÄƒtre reprezentant.</div>';
      $('btnTrimiteVot').disabled=true; return;
    }
    // corespondenta
    if((s.tip||'').toLowerCase()==='corespondenta' && s.instructiuni){
      $('helloVoter').innerHTML='Bun venit, <b>'+escapeHTML(s.nume)+'</b> â€” <span class="badge gray">vot prin corespondenÈ›Äƒ</span>';
      $('intrebari').innerHTML='<div class="card">Votul dvs. prin corespondenÈ›Äƒ este deja Ã®nregistrat.</div>';
      $('btnTrimiteVot').disabled=true; return;
    }

    $('helloVoter').innerHTML='Bun venit, <b>'+escapeHTML(s.nume)+'</b>';

    const agSnap=await sessRef.collection('agenda').orderBy('idx').get();
    const agenda=agSnap.docs.map(d=>d.data());
    renderVoterForm(agenda);

    $('btnTrimiteVot').onclick = async ()=>{
      const choices={}; qsa('[name^=q_]').forEach(inp=>{ if(inp.checked){ const idx=inp.name.split('_')[1]; choices[idx]=inp.value; } });
      if(Object.keys(choices).length===0) return alert('SelectaÈ›i opÈ›iuni de vot Ã®nainte de trimitere.');
      const weight = Number(s.totalActiuniReprezentate || s.actiuniProprii || s.actiuni || 0);
      try{
        await sessRef.collection('votes').doc(s.token).set({voterToken:s.token, voterName:s.nume, weight, choices, source:'online', ts: Date.now()},{merge:true});
        $('statusVot').textContent='âœ… Votul a fost Ã®nregistrat. VÄƒ mulÈ›umim!'; $('btnTrimiteVot').disabled=true;
      }catch(e){ console.error(e); alert('Eroare la trimiterea votului: '+e.message); }
    };
  }catch(e){ console.error(e); $('helloVoter').textContent='Eroare la Ã®ncÄƒrcare: '+e.message; }
}
function disableVoteUI(msg){
  $('intrebari').innerHTML='<div class="card">'+escapeHTML(msg)+'</div>'; $('btnTrimiteVot').disabled=true;
}
function renderVoterForm(agenda){
  const root=$('intrebari'); root.innerHTML='';
  agenda.forEach(a=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<div><b>#${a.idx}. ${escapeHTML(a.titlu)}</b></div>
      <label><input type="radio" name="q_${a.idx}" value="DA"> DA</label> &nbsp;
      <label><input type="radio" name="q_${a.idx}" value="NU"> NU</label> &nbsp;
      <label><input type="radio" name="q_${a.idx}" value="ABTINERE"> AbÈ›inere</label>`;
    root.appendChild(div);
  });
}

/* ===== PrezenÈ›Äƒ: afiÈ™are + PDF ===== */
$('btnPresence').addEventListener('click', async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const [shSnap,vSnap]=await Promise.all([
    sessRef.collection('shareholders').get(),
    sessRef.collection('votes').get()
  ]);
  const votes=new Set(); vSnap.forEach(d=>votes.add((d.data().voterToken)));
  const sh = shSnap.docs.map(d=>d.data());
  const total = sh.reduce((s,a)=>s + (Number(a.actiuniProprii ?? a.actiuni)||0) + (Number(a.actiuniReprezentate)||0),0);
  let prez=0;
  const tbody=$('presenceTable'); tbody.innerHTML='';
  sh.forEach((a,i)=>{
    const voted = votes.has(a.token) || ((a.tip||'').toLowerCase()==='corespondenta' && a.instructiuni);
    const tip = a.reprezentatDe ? 'Prin procurÄƒ' : ((a.tip||'')||'Online');
    const obs = a.reprezentatDe ? ('Reprezentat de '+a.reprezentatDe) : ((a.tip||'').toLowerCase()==='corespondenta'?'Vot Ã®nregistrat':'');
    if(voted) prez += Number(a.actiuni)||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${escapeHTML(a.nume)}</td><td>${a.actiuni}</td><td>${escapeHTML(tip)}</td><td>${voted? 'âœ… Prezent':'âŒ Absent'}</td><td>${escapeHTML(obs)}</td>`;
    tbody.appendChild(tr);
  });
  $('presenceStats').innerHTML = `Total acÈ›iuni: <b>${total}</b> â€¢ Prezente: <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ Cvorum: <b>${pct(prez,total)}</b>`;
  $('presencePanel').style.display='block';
});
$('btnPresencePDF').addEventListener('click', async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const [sess,shSnap,vSnap]=await Promise.all([sessRef.get(),sessRef.collection('shareholders').get(),sessRef.collection('votes').get()]);
  const cfg=sess.exists? sess.data():{};
  const votes=new Set(); vSnap.forEach(d=>votes.add((d.data().voterToken)));
  const sh = shSnap.docs.map(d=>d.data());
  const total = sh.reduce((s,a)=>s + (Number(a.actiuniProprii ?? a.actiuni)||0) + (Number(a.actiuniReprezentate)||0),0);
  let prez=0;
  let rows='';
  sh.forEach((a,i)=>{
    const voted = votes.has(a.token) || ((a.tip||'').toLowerCase()==='corespondenta' && a.instructiuni);
    const tip = a.reprezentatDe ? 'Prin procurÄƒ' : ((a.tip||'')||'Online');
    const obs = a.reprezentatDe ? ('Reprezentat de '+a.reprezentatDe) : ((a.tip||'').toLowerCase()==='corespondenta'?'Vot Ã®nregistrat':'');
    if(voted) prez += Number(a.actiuni)||0;
    rows+=`<tr><td>${i+1}</td><td>${escapeHTML(a.nume)}</td><td>${a.actiuni}</td><td>${escapeHTML(tip)}</td><td>${voted? 'Prezent':'Absent'}</td><td>${escapeHTML(obs)}</td></tr>`;
  });
  const html=`<html><head><title>Raport prezenÈ›Äƒ</title>
  <style>@page{size:A4;margin:18mm}body{font-family:Arial;color:#222}h1,h2,h3{color:#0b3d91}
  table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid #e5e7eb;padding:6px;text-align:left}th{background:#f3f4f6}
  </style></head><body>
  <h1>Destine Holding S.A. â€“ Raport prezenÈ›Äƒ AGA</h1>
  <div>Data È™edinÈ›ei: <b>${escapeHTML(cfg.date||'')}</b> â€¢ Sesiune: <b>${escapeHTML(sid)}</b></div><hr>
  <div>Total acÈ›iuni: <b>${total}</b> â€¢ Prezente: <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ Cvorum: <b>${pct(prez,total)}</b></div>
  <table><thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>Tip</th><th>Status</th><th>ObservaÈ›ii</th></tr></thead><tbody>${rows}</tbody></table>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.print();
});

/* ===== AdÄƒugare manualÄƒ vot prin corespondenÈ›Äƒ ===== */
$('btnAddCorr').addEventListener('click', async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const shSnap=await sessRef.collection('shareholders').get();
  const list=shSnap.docs.map(d=>d.data());
  if(!list.length) return alert('Nu existÄƒ acÈ›ionari publicaÈ›i.');
  const nume = prompt('IntroduceÈ›i exact numele acÈ›ionarului (conform listei):');
  if(!nume) return;
  const found = list.find(s=> (s.nume||'').trim().toLowerCase() === nume.trim().toLowerCase());
  if(!found) return alert('Nume negÄƒsit Ã®n aceastÄƒ sesiune.');
  if(found.reprezentatDe) return alert('AcÈ›ionar reprezentat prin procurÄƒ: votul se exprimÄƒ de reprezentant.');
  const instr = prompt('InstrucÈ›iuni vot (ex: 1:DA;2:NU;3:ABTINERE):');
  if(!instr) return;
  try{
    await sessRef.collection('votes').doc(found.token).set({
      voterToken:found.token, voterName:found.nume,
      weight:Number(found.totalActiuniReprezentate || found.actiuniProprii || found.actiuni || 0),
      choices:parseInstr(instr), source:'corespondenta_manual', ts: Date.now()
    },{merge:true});
    alert('Vot prin corespondenÈ›Äƒ Ã®nregistrat pentru: '+found.nume);
  }catch(e){ console.error(e); alert('Eroare: '+e.message); }
});

/* ===== Raport voturi (PDF) ===== */
$('btnPDF').addEventListener('click', async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const [sess,shSnap,agSnap,vSnap]=await Promise.all([
    sessRef.get(),
    sessRef.collection('shareholders').get(),
    sessRef.collection('agenda').orderBy('idx').get(),
    sessRef.collection('votes').get()
  ]);
  const cfg=sess.exists? sess.data():{};
  const sh=shSnap.docs.map(d=>d.data());
  const agenda=agSnap.docs.map(d=>d.data());
  const votes=vSnap.docs.map(d=>d.data());
  const total=sh.reduce((s,a)=>s+(Number(a.actiuniProprii ?? a.actiuni)||0)+(Number(a.actiuniReprezentate)||0),0);
  const prez=votes.reduce((s,v)=>s+(Number(v.weight)||0),0);

  let html=`<html><head><title>Raport voturi</title>
  <style>@page{size:A4;margin:18mm}body{font-family:Arial,Helvetica,sans-serif;color:#222}
  h1,h2,h3{color:#0b3d91;margin:0 0 8px}.line{height:1px;background:#ddd;margin:12px 0}
  table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:6px;text-align:left} th{background:#f3f4f6}
  </style></head><body>`;
  html+=`<h1>Destine Holding S.A. â€“ Raport voturi AGA</h1>
         <div>Data È™edinÈ›ei: <b>${escapeHTML(cfg.date||'')}</b> â€¢ Sesiune: <b>${escapeHTML(sid)}</b></div>
         <div>FereastrÄƒ vot: <b>${escapeHTML(cfg.startTime||'-')}</b> â€“ <b>${escapeHTML(cfg.endTime||'-')}</b></div>
         <div class="line"></div>
         <div>Total acÈ›iuni: <b>${total}</b> â€¢ Prezente (pondere voturi): <b>${prez}</b> (<b>${pct(prez,total)}</b>)</div>
         <div class="line"></div>`;

  // AcÈ›ionari cu procente
  html+=`<h3>AcÈ›ionari</h3>
         <table><thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni proprii</th><th>Reprezentate</th><th>Total ponderare</th><th>% din total</th><th>Tip</th></tr></thead><tbody>`;
  sh.sort((a,b)=> (b.totalActiuniReprezentate||b.actiuni||0) - (a.totalActiuniReprezentate||a.actiuni||0)).forEach((a,i)=>{
    const own=Number(a.actiuniProprii ?? a.actiuni)||0, rep=Number(a.actiuniReprezentate||0), tot=Number(a.totalActiuniReprezentate || (own+rep));
    html+=`<tr><td>${i+1}</td><td>${escapeHTML(a.nume)}</td><td>${own}</td><td>${rep}</td><td>${tot}</td><td>${pct(tot,total)}</td><td>${escapeHTML(a.tip||'')}</td></tr>`;
  });
  html+=`</tbody></table><div class="line"></div>`;

  // Tabel rezultate pe punct
  const tally=agenda.map(()=>({da:0,nu:0,ab:0}));
  votes.forEach(v=>{
    const wt=Number(v.weight)||0, ch=v.choices||{};
    Object.keys(ch).forEach(k=>{
      const idx=parseInt(k,10)-1; if(isNaN(idx)||idx<0||idx>=tally.length) return;
      const val=(ch[k]||'').toUpperCase();
      if(val==='DA') tally[idx].da+=wt; else if(val==='NU') tally[idx].nu+=wt; else tally[idx].ab+=wt;
    });
  });
  html+=`<h3>Rezultate pe puncte</h3>
         <table><thead><tr><th>#</th><th>Punct</th><th>DA</th><th>NU</th><th>AbÈ›ineri</th><th>% DA</th></tr></thead><tbody>`;
  tally.forEach((t,i)=>{ const tot=t.da+t.nu+t.ab; html+=`<tr><td>${i+1}</td><td>${escapeHTML(agenda[i].titlu)}</td><td>${t.da}</td><td>${t.nu}</td><td>${t.ab}</td><td>${pct(t.da,tot)}</td></tr>`; });
  html+=`</tbody></table>
         <div style="margin-top:16px;font-size:12px;color:#777">Elaborat cu platforma AGA â€“ Destine Holding S.A.</div>
         </body></html>`;
  const win=window.open('','_blank'); win.document.write(html); win.print();
});
})();
</script>
</body>
</html>
