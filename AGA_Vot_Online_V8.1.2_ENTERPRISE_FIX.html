<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Destine Holding S.A. â€“ PlatformÄƒ AGA (V8.1.2)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#003399; --blue2:#1d4ed8; --bg:#f6f7fb; --card:#fff; --line:#e6eaf0; --text:#1b2430;
  --muted:#68707f; --green:#0f5132; --greenbg:#e8faef; --warn:#8a5a00; --warnbg:#fff7e6; --graybg:#f3f4f6;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter",system-ui,Arial}
header{background:#fff;border-bottom:1px solid var(--line)}
.headwrap{max-width:1200px;margin:auto;padding:12px 16px;display:flex;align-items:center;gap:16px;justify-content:space-between}
.logo{height:56px}
.livebar{font-size:12px;background:var(--greenbg);color:var(--green);border:1px solid #b7efd0;padding:6px 10px;border-radius:999px;white-space:nowrap}
.hero{background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff}
.hero .hwrap{max-width:1200px;margin:auto;padding:16px}
.hero h1{margin:0 0 4px;font-size:18px}
.hero p{margin:0;opacity:.95}
.version{max-width:1200px;margin:8px auto 0;color:#8b91a2;font-size:12px;padding:0 16px}
.container{max-width:1200px;margin:16px auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:16px}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
.hr{height:1px;background:var(--line);margin:14px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row>div{flex:1 1 260px}
label{font-weight:600;display:block;margin:6px 0}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d7dce6;background:#fff;font-size:15px}
button{padding:10px 14px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-weight:700;cursor:pointer}
button:hover{filter:brightness(.97)}
button.gray{background:#e9edf5;color:#102a63}
button.green{background:#16a34a}
button.red{background:#cc3344}
button.sent{background:#16a34a !important;color:#fff !important}
button.toggled{background:var(--blue) !important;color:#fff !important}
small.hint{color:var(--muted)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
th{background:#eef2ff}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-weight:700}
.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;margin-left:6px}
.badge.green{background:var(--greenbg);color:var(--green)}
.badge.warn{background:var(--warnbg);color:var(--warn)}
.badge.gray{background:#eef2ff;color:#1e3a8a}
.name-strong{font-weight:700;color:#003399}
.agenda-title{font-weight:700;background:#f3f6ff;padding:6px;border-radius:8px;margin-bottom:6px}
#votant label{display:inline-flex;align-items:center;gap:6px;margin-right:16px}
#votant input[type=radio]{margin:0}
.toast{position:fixed;right:16px;top:16px;background:var(--greenbg);color:var(--green);padding:10px 14px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.12);z-index:9999;display:none}
.rep-row{background:#fafafa}
.corr-row{background:#fff9e9}
.muted{color:var(--muted);font-size:13px}
.mono{font-family:ui-monospace,Consolas,Menlo,monospace}
footer{text-align:center;color:#8b91a2;font-size:12px;padding:18px}
</style>
</head>
<body>

<header>
  <div class="headwrap">
    <img class="logo" alt="Destine Holding" src="https://dh-vot.github.io/VotAGA/logo_Destine-Holding_oficial-color.png">
    <div id="livebar" class="livebar">Stare: aÈ™tept conexiuni votanÈ›iâ€¦</div>
  </div>
  <div class="hero"><div class="hwrap">
    <h1>Destine Holding S.A.</h1>
    <p>Instrument digital pentru gestionarea prezenÈ›ei È™i a voturilor acÈ›ionarilor</p>
  </div></div>
  <div class="version">V8.1.2 ENTERPRISE FIX â€“ compatibil Windows 11 + GitHub Pages</div>
</header>

<!-- Gateway -->
<div class="container" id="gateway">
  <div class="card" style="max-width:560px;margin:0 auto">
    <h3>ğŸ” Acces organizator</h3>
    <div class="row">
      <div>
        <label>IntroduceÈ›i parola</label>
        <input id="parolaOrganizator" type="password" placeholder="Parola (implicit: DH2026)">
      </div>
      <div style="flex:0 0 auto;align-self:end">
        <button id="btnOrganizator">IntrÄƒ ca organizator</button>
      </div>
      <div style="flex:0 0 auto;align-self:end">
        <button id="btnSchimbaParola" class="gray">ğŸ”‘ SchimbÄƒ parola</button>
      </div>
    </div>
    <p class="muted">IntroduceÈ›i parola pentru a accesa panoul organizatorului.</p>
  </div>
</div>

<!-- Organizator -->
<div class="container" id="organizator" style="display:none">
  <h2>âš™ï¸ SetÄƒri AGA <span class="pill">LIVE</span></h2>
  <div class="row">
    <div><label>Companie</label><input id="companie" value="Destine Holding S.A."></div>
    <div><label>Data È™edinÈ›ei</label><input id="dataSedintei" type="date"></div>
    <div><label>ID sesiune (ex: AGA_2025_DH)</label><input id="sessionId" value="AGA_2025_DH"><small class="hint">Folosit Ã®n Firestore È™i Ã®n linkurile votanÈ›ilor (<span class="mono">sid=...</span>).</small></div>
  </div>
  <div class="row">
    <div><label>ğŸ•’ Ãnceput vot</label><input id="voteStart" type="datetime-local"></div>
    <div><label>ğŸ•’ SfÃ¢rÈ™it vot</label><input id="voteEnd" type="datetime-local"></div>
    <div><label>Quorum minim (%)</label><input id="quorumMin" type="number" min="0" max="100" value="50"></div>
  </div>

  <div class="hr"></div>

  <h3>ğŸ‘¤ AcÈ›ionari & PrezenÈ›Äƒ</h3>
  <div class="row">
    <button id="btnImportCSV">ğŸ“¥ ImportÄƒ acÈ›ionari (CSV)</button>
    <button id="btnExportCSV" class="gray">ğŸ“¤ ExportÄƒ acÈ›ionari</button>
    <button id="btnGenTok">ğŸ”— GenereazÄƒ tokenuri</button>
    <button id="btnPresence" class="gray">ğŸ‘ï¸ AfiÈ™eazÄƒ prezenÈ›a</button>
    <button id="btnPresencePDF" class="gray">ğŸ§¾ ExportÄƒ raport prezenÈ›Äƒ (PDF)</button>
    <button id="btnAddCorr" class="gray">âœ‰ï¸ AdaugÄƒ vot prin corespondenÈ›Äƒ</button>
    <button id="btnExportLinks" class="gray">ğŸ“¦ GenereazÄƒ listÄƒ trimitere (CSV)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>Telefon</th><th>Email</th><th>ProcurÄƒPentru</th>
        <th>Tip</th><th>InstrucÈ›iuniVot</th><th>Token</th><th>Link votant</th><th>Status vot</th>
      </tr>
    </thead>
    <tbody id="listaActionari"></tbody>
  </table>
  <div id="rezumatPrezenta" class="muted"></div>

  <div class="card" id="presencePanel" style="display:none">
    <h3>ğŸ“Š PrezenÈ›Äƒ curentÄƒ</h3>
    <div id="presenceStats" class="muted"></div>
    <table>
      <thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>% total</th><th>Tip</th><th>Status</th><th>ObservaÈ›ii</th></tr></thead>
      <tbody id="presenceTable"></tbody>
    </table>
  </div>

  <div class="hr"></div>

  <h3>ğŸ—“ï¸ Ordinea de zi</h3>
  <div class="row">
    <button id="btnImportODZ">ğŸ“¥ ImportÄƒ Ordinea de zi (CSV)</button>
    <button id="btnExportODZ" class="gray">ğŸ“¤ ExportÄƒ Ordinea de zi</button>
    <button id="btnAdaugaPunct">â• AdaugÄƒ punct manual</button>
  </div>
  <div id="ordineContainer"></div>

  <div class="hr"></div>
  <div class="row">
    <button id="btnPublish" class="green">ğŸ“¡ PublicÄƒ Ã®n Firestore</button>
    <button id="btnConnectLive">ğŸ”„ ReÃ®mprospÄƒtare live</button>
    <button id="btnPDF">ğŸ–¨ï¸ ExportÄƒ raport voturi (PDF)</button>
    <button id="btnSaveLocal" class="gray">ğŸ’¾ SalveazÄƒ local</button>
    <button id="btnLoadLocal" class="gray">ğŸ“‚ ÃncarcÄƒ din copie</button>
    <button id="btnReset" class="red">â™»ï¸ Reset total</button>
  </div>

  <div class="card">
    <h3>ğŸ“Š Rezultate live</h3>
    <div id="rezumatVoturi" class="muted"></div>
    <table>
      <thead><tr><th>#</th><th>Punct</th><th>DA</th><th>NU</th><th>AbÈ›ineri</th><th>% DA</th></tr></thead>
      <tbody id="rezultate"></tbody>
    </table>
  </div>
</div>

<!-- Votant -->
<div class="container" id="votant" style="display:none">
  <h2>ğŸ—³ï¸ Votant</h2>
  <p id="helloVoter" class="muted"></p>
  <div id="intrebari"></div>
  <div class="hr"></div>
  <button id="btnTrimiteVot">Trimite votul</button>
  <p id="statusVot" class="muted"></p>
</div>

<div id="toast" class="toast"></div>
<footer>Destine Holding S.A. Â© 2025 â€” PlatformÄƒ AGA V8.1.2 ENTERPRISE FIX</footer>

<!-- Firebase compat (9.x compat builds) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- URL cleanup pentru GitHub Pages -->
<script>
(function(){
  const u=location.href;
  if(u.includes('.html/') && u.includes('?')) location.replace(u.replace('.html/','.html'));
  if(u.includes('#?')) location.replace(u.replace('#?','?'));
})();
</script>

<script>
(function(){
'use strict';
/* ========== Helpers ========== */
const $=id=>document.getElementById(id);
const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const splitCSV=line=>{let out=[],cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c=='"'){q=!q;continue;}if(c==","&&!q){out.push(cur);cur='';continue;}cur+=c;}out.push(cur);return out.map(s=>s.trim());};
const escCSV=s=>(s==null)?'':(/[,"\n]/.test(String(s))?('"'+String(s).replace(/"/g,'""')+'"'):String(s));
const pct=(x,tot)=>tot?((x/tot)*100).toFixed(2)+'%':'0.00%';
const downloadBlob=(content,type,name)=>{const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(u),800);};
const genTok=seed=>{let h=0;seed=String(seed||'');for(let i=0;i<seed.length;i++){h=(h*31+seed.charCodeAt(i))|0;}h=Math.abs(h);return h.toString(36).slice(0,8)};
const parseInstr=s=>{const o={}; if(!s) return o; s.split(';').forEach(p=>{const m=p.split(':'); if(m.length===2)o[String(m[0]).trim()]=String(m[1]).trim().toUpperCase();}); return o;};
const todayISO=()=>{const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`;};
const toRoDate=d=>{const dt=new Date(d); return `${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}.${dt.getFullYear()}`;}
const toRoTime=d=>{const dt=new Date(d); return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;}
const showToast=(msg)=>{const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500);}
const setLiveBar=txt=>{ const el=$('livebar'); if(el) el.textContent=txt; }

/* ========== State ========== */
let actionari=[], ordineZi=[];
let parolaCorecta = localStorage.getItem('parolaAGA') || 'DH2026';
let votesUnsub=null; let votedTokens=new Set();
let presenceShown = localStorage.getItem('presenceShown')==='1';

/* ========== Firebase ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDbVELVBtmoS1m0761QQ2kI5Cvsjc4cjwc",
  authDomain: "destineaga.firebaseapp.com",
  projectId: "destineaga",
  storageBucket: "destineaga.firebasestorage.app",
  messagingSenderId: "997907169795",
  appId: "1:997907169795:web:e06e62d522a13b01e48436",
  measurementId: "G-CS7C7LQVD5"
};
const app = firebase.initializeApp(firebaseConfig);
const db  = firebase.firestore();

/* ========== Organizator â€“ Gateway ========== */
$('btnOrganizator').onclick=()=>{
  const p=$('parolaOrganizator').value.trim();
  if(!p) return alert('IntroduceÈ›i parola!');
  if(p===parolaCorecta){
    $('gateway').style.display='none';
    $('organizator').style.display='block';
    if(!$('dataSedintei').value) $('dataSedintei').value=todayISO();
    if(presenceShown){ $('btnPresence').classList.add('toggled'); $('btnPresence').textContent='âœ… PrezenÈ›Äƒ afiÈ™atÄƒ'; $('presencePanel').style.display='block'; }
  } else alert('ParolÄƒ incorectÄƒ!');
};
$('btnSchimbaParola').onclick=()=>{
  const n=prompt('IntroduceÈ›i noua parolÄƒ:');
  if(n&&n.trim()!==''){ parolaCorecta=n.trim(); localStorage.setItem('parolaAGA',parolaCorecta); alert('Parola a fost schimbatÄƒ!'); }
};

/* ========== AcÈ›ionari CSV ========== */
$('btnImportCSV').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='.csv';
  i.onchange=e=>{
    const f=e.target.files[0]; const r=new FileReader();
    r.onload=ev=>{
      const rows=ev.target.result.split(/\r?\n/).filter(x=>x.trim());
      const hdr = splitCSV(rows[0]).map(h=>h.toLowerCase());
      const idx = (name)=>hdr.indexOf(name.toLowerCase());
      actionari=[];
      for(let k=1;k<rows.length;k++){
        const c=splitCSV(rows[k]); if(!c.length || !c[0]) continue;
        const obj={
          nume:c[idx('nume')]||'',
          actiuni:parseInt(c[idx('actiuni')]||'0',10)||0,
          tel:c[idx('telefon')]||'',
          email:c[idx('email')]||'',
          procura:c[idx('procurÄƒpentru')]||c[idx('procura pentru')]||c[idx('procura')]||'',
          instructiuni:c[idx('instrucÈ›iunivot')]||c[idx('instructiuni vot')]||c[idx('instrucÈ›iuni vot')]||'',
          tip:c[idx('tip')]||'',
          token:c[idx('token')]||''
        };
        actionari.push(obj);
      }
      renderActionari();
    };
    r.readAsText(f);
  };
  i.click();
};
$('btnExportCSV').onclick=()=>{
  let csv='Nume,Actiuni,Telefon,Email,ProcurÄƒPentru,InstrucÈ›iuniVot,Tip,Token\n';
  actionari.forEach(a=>{ csv+=`${escCSV(a.nume)},${a.actiuni},${escCSV(a.tel||'')},${escCSV(a.email||'')},${escCSV(a.procura||'')},${escCSV(a.instructiuni||'')},${escCSV(a.tip||'')},${escCSV(a.token||'')}\n`;});
  downloadBlob(csv,'text/csv;charset=utf-8;','actionari_export.csv');
};
$('btnGenTok').onclick=()=>{
  actionari=actionari.map(a=>{ if(!a.token||a.token.trim()===''){ a.token=genTok(`${a.nume||''}|${a.email||''}|${a.tel||''}`);} return a;});
  renderActionari(); alert('Tokenurile au fost generate.');
};

function markSent(key, channel){ localStorage.setItem(`sent_${channel}_${key}`,'1'); }
function isSent(key, channel){ return localStorage.getItem(`sent_${channel}_${key}`)==='1'; }

function renderActionari(votesMap=null, presenceSet=null){
  const tb=$('listaActionari'); tb.innerHTML='';
  const sid=$('sessionId').value.trim()||'AGA_2025_DH';
  const base=location.href.replace(/[?#].*$/,'');
  const total = actionari.reduce((s,a)=>s+(Number(a.actiuni)||0),0);

  const byName={}; actionari.forEach(a=> byName[(a.nume||'').trim().toLowerCase()]=a.token);
  const voted = votesMap || votedTokens;
  const presentSetSafe = presenceSet || new Set();

  let prez=0, cntVot=0;
  actionari.forEach((a,i)=>{
    const token=a.token||''; const link=`${base}?sid=${encodeURIComponent(sid)}&t=${encodeURIComponent(token)}`;
    const tipL=(a.tip||'').toLowerCase(); const isCorr = (tipL==='corespondenta'||tipL==='corespondenÈ›Äƒ') && a.instructiuni;
    const votedDirect = voted.has(token); if(votedDirect) cntVot++;

    let repVoted=false, repName='';
    if((a.procura||'').trim()){
      const repTok=byName[(a.procura||'').trim().toLowerCase()];
      repVoted = !!repTok && voted.has(repTok);
      repName = a.procura;
    }

    // PREZENÈšÄ‚ doar dacÄƒ: conectat SAU a votat direct SAU corespondenÈ›Äƒ validÄƒ SAU reprezentantul a votat
    const connected = presentSetSafe.has(token);
    const present = connected || isCorr || repVoted || votedDirect;
    if(present) prez += Number(a.actiuni)||0;

    let status='';
    if(repVoted){ status=`âœ… Prin reprezentant â€” ${esc(repName)}`; }
    else if(isCorr){ status='âœ… CorespondenÈ›Äƒ (vot Ã®nregistrat)'; }
    else if(votedDirect){ status='âœ… A votat online'; }
    else if(connected){ status='ğŸŸ¢ Conectat (prezent)'; }
    else { status='neÃ®nregistrat'; }

    const subj=encodeURIComponent('Link vot AGA â€“ Destine Holding S.A.');
    const body=encodeURIComponent(`BunÄƒ ziua ${a.nume},\n\nLinkul dvs. unic pentru vot:\n${link}\n\nSecretariatul AGA â€“ Destine Holding S.A.`);
    const mailHref=`mailto:${encodeURIComponent(a.email||'')}?subject=${subj}&body=${body}`;
    const waHref=`https://wa.me/?text=${encodeURIComponent('Link vot AGA Destine Holding: '+link)}`;

    const mailKey=`${sid}__${token}__email`, waKey=`${sid}__${token}__wa`;
    const mailSent=isSent(mailKey,'email'), waSent=isSent(waKey,'wa');

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td class="name-strong">${esc(a.nume)}</td>
      <td>${a.actiuni}</td>
      <td>${esc(a.tel||'')}</td>
      <td>${esc(a.email||'')}</td>
      <td>${esc(a.procura||'')}</td>
      <td>${esc(a.tip||'')}</td>
      <td class="mono">${esc(a.instructiuni||'')}</td>
      <td class="mono">${esc(token)}</td>
      <td>
        <button data-copy="${encodeURIComponent(link)}">CopiazÄƒ link</button>
        <a href="${mailHref}"><button class="gray ${mailSent?'sent':''}" data-mail="${mailKey}" type="button">${mailSent?'âœ… Trimis':'âœ‰ï¸ Email'}</button></a>
        <a href="${waHref}" target="_blank" rel="noopener"><button class="gray ${waSent?'sent':''}" data-wa="${waKey}" type="button">${waSent?'âœ… Trimis':'ğŸ’¬ WhatsApp'}</button></a>
      </td>
      <td>${status}</td>`;
    tb.appendChild(tr);
  });

  tb.querySelectorAll('button[data-copy]').forEach(b=> b.addEventListener('click',ev=>{
    const u=decodeURIComponent(ev.target.getAttribute('data-copy'));
    navigator.clipboard.writeText(u).then(()=>alert('Link copiat:\n'+u));
  }));
  tb.querySelectorAll('button[data-mail]').forEach(btn=>{
    btn.addEventListener('click',()=>{ markSent(btn.getAttribute('data-mail'),'email'); btn.classList.add('sent'); btn.textContent='âœ… Trimis'; });
  });
  tb.querySelectorAll('button[data-wa]').forEach(btn=>{
    btn.addEventListener('click',()=>{ markSent(btn.getAttribute('data-wa'),'wa'); btn.classList.add('sent'); btn.textContent='âœ… Trimis'; });
  });

  $('rezumatPrezenta').innerHTML=
    `Total acÈ›iuni: <b>${total}</b> â€¢ Prezente (incl. conexiuni/procuri/corespondenÈ›Äƒ): <b>${prez}</b> `+
    `(<b>${pct(prez,total)}</b>) â€¢ Au votat online: <b>${cntVot}</b> / <b>${actionari.length}</b>`;
}

/* ========== ODZ ========== */
$('btnAdaugaPunct').onclick=()=>addPunct('','Majoritate simplÄƒ (>50%)','Nu','');
$('btnImportODZ').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='.csv';
  i.onchange=e=>{
    const f=e.target.files[0]; const r=new FileReader();
    r.onload=ev=>{
      const rows=ev.target.result.split(/\r?\n/).filter(x=>x.trim());
      ordineZi=[]; $('ordineContainer').innerHTML='';
      for(let k=1;k<rows.length;k++){const c=splitCSV(rows[k]);const t=c[1]||c[0]||''; if(!t) continue; addPunct(t,c[2]||'Majoritate simplÄƒ (>50%)',c[3]||'Nu',c[4]||'');}
      alert('Ordinea de zi a fost importatÄƒ.');
    }; r.readAsText(f);
  }; i.click();
};
$('btnExportODZ').onclick=()=>{
  let csv='Titlu,Majoritate,VotSecret,Observatii\n';
  ordineZi.forEach(o=>{ csv+=`${escCSV(o.titlu)},${escCSV(o.majoritate)},${escCSV(o.votSecret)},${escCSV(o.observatii)}\n`; });
  downloadBlob(csv,'text/csv;charset=utf-8;','ordine_zi_export.csv');
};
function addPunct(titlu,majoritate,votSecret,observatii){
  const idx=ordineZi.length; const d=document.createElement('div'); d.className='card';
  d.innerHTML=`<div class="agenda-title">#${idx+1}. <span class="name-strong">${esc(titlu||'(fÄƒrÄƒ titlu)')}</span></div>
  <label>Titlu</label><input data-f="titlu" value="${esc(titlu)}">
  <label>Majoritate</label><input data-f="majoritate" value="${esc(majoritate)}">
  <label>Vot secret</label><select data-f="votSecret"><option${votSecret==='Nu'?' selected':''}>Nu</option><option${votSecret==='Da'?' selected':''}>Da</option></select>
  <label>ObservaÈ›ii</label><textarea data-f="observatii">${esc(observatii)}</textarea>`;
  $('ordineContainer').appendChild(d);
  ordineZi.push({titlu,majoritate,votSecret,observatii});
  d.querySelectorAll('[data-f]').forEach(c=> c.addEventListener('input',()=>{const f=c.getAttribute('data-f'); ordineZi[idx][f]=c.value;}));
}

/* ========== Publicare & Live ========== */
$('btnPublish').onclick=async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  if(!confirm('PublicaÈ›i setÄƒrile + acÈ›ionarii + ODZ?')) return;
  try{
    const sessRef=db.collection('sessions').doc(sid);
    const start=$('voteStart').value? new Date($('voteStart').value).toISOString():'';
    const end=$('voteEnd').value? new Date($('voteEnd').value).toISOString():'';
    await sessRef.set({company:$('companie').value,date:$('dataSedintei').value,startTime:start,endTime:end,quorumMin:Number($('quorumMin').value)||50,updated:Date.now()},{merge:true});
    // clean colecÈ›ii
    const delAll=async col=>{const s=await col.get(); if(s.empty) return; const b=db.batch(); s.forEach(d=>b.delete(d.ref)); await b.commit();};
    await delAll(sessRef.collection('shareholders')); await delAll(sessRef.collection('agenda')); await delAll(sessRef.collection('votes')); await delAll(sessRef.collection('presence'));
    // tokens
    actionari=actionari.map(a=>{ if(!a.token||a.token.trim()===''){ a.token=genTok(`${a.nume||''}|${a.email||''}|${a.tel||''}`);} return a; });
    // scriere acÈ›ionari
    const b1=db.batch(); actionari.forEach(a=>{
      b1.set(sessRef.collection('shareholders').doc(a.token),{
        token:a.token,nume:a.nume,actiuni:Number(a.actiuni)||0,tel:a.tel||'',email:a.email||'',
        procura:a.procura||'',tip:a.tip||'',instructiuni:a.instructiuni||'',reprezentatDe:''
      },{merge:true});
    }); await b1.commit();
    // map nume->token
    const shSnap=await sessRef.collection('shareholders').get(); const byName={}; shSnap.forEach(d=>{const s=d.data();byName[(s.nume||'').trim().toLowerCase()]=s.token;});
    // set reprezentatDe (nu pentru corespondenÈ›Äƒ)
    const bMark=db.batch(); shSnap.forEach(d=>{
      const s=d.data(); const hasCorr=(String(s.tip||'').toLowerCase().startsWith('coresp')) && s.instructiuni;
      const proc=(s.procura||'').trim(); if(proc && !hasCorr){ bMark.set(sessRef.collection('shareholders').doc(s.token),{reprezentatDe:proc},{merge:true}); }
      else bMark.set(sessRef.collection('shareholders').doc(s.token),{reprezentatDe:''},{merge:true});
    }); await bMark.commit();
    // consolidare reprezentÄƒri
    const shSnap2=await sessRef.collection('shareholders').get(); const details={}, byName2={};
    shSnap2.forEach(d=>{const s=d.data(); details[s.token]={own:Number(s.actiuni)||0,rep:0,name:s.nume}; byName2[(s.nume||'').trim().toLowerCase()]=s.token;});
    shSnap2.forEach(d=>{
      const s=d.data(); const hasCorr=(String(s.tip||'').toLowerCase().startsWith('coresp')) && s.instructiuni;
      const to=(s.procura||'').trim().toLowerCase(); if(!hasCorr && to){ const repTok=byName2[to]; if(repTok && details[repTok]) details[repTok].rep+=Number(s.actiuni)||0; }
    });
    const bCon=db.batch(); Object.keys(details).forEach(t=>{const x=details[t]; bCon.set(sessRef.collection('shareholders').doc(t),{actiuniProprii:x.own,actiuniReprezentate:x.rep,totalActiuniReprezentate:x.own+x.rep},{merge:true});});
    await bCon.commit();
    // agenda
    const b2=db.batch(); ordineZi.forEach((o,i)=> b2.set(sessRef.collection('agenda').doc(String(i+1)),{idx:i+1,titlu:o.titlu,majoritate:o.majoritate,votSecret:o.votSecret,observatii:o.observatii||''})); await b2.commit();
    // corespondenÈ›Äƒ â†’ votes (completeazÄƒ automat lipsurile cu AbÈ›inere)
    const agSnap=await sessRef.collection('agenda').orderBy('idx').get(); const ag=agSnap.docs.map(d=>d.data());
    const shSnap3=await sessRef.collection('shareholders').get(); const bVotes=db.batch();
    shSnap3.forEach(d=>{const s=d.data(); const isCorr=(String(s.tip||'').toLowerCase().startsWith('coresp'))&&s.instructiuni;
      if(isCorr){
        const base=parseInstr(s.instructiuni), full={};
        ag.forEach(x=>{const k=String(x.idx); full[k]=base[k]||'ABTINERE';});
        bVotes.set(sessRef.collection('votes').doc(s.token),{voterToken:s.token,voterName:s.nume,weight:Number(s.actiuniProprii||s.actiuni||0),choices:full,source:'corespondenta',ts:Date.now()},{merge:true});
      }
    }); await bVotes.commit();
    alert('Publicare reuÈ™itÄƒ.');
  }catch(e){ console.error(e); alert('Eroare: '+e.message); }
};

$('btnConnectLive').onclick=()=>connectLive();
async function connectLive(){
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  if(votesUnsub){ votesUnsub(); votesUnsub=null; }
  const sessRef=db.collection('sessions').doc(sid);
  const [agSnap,shSnap]=await Promise.all([sessRef.collection('agenda').orderBy('idx').get(),sessRef.collection('shareholders').get()]);
  const agenda=agSnap.docs.map(d=>d.data());
  const shares={}; const byName={};
  shSnap.forEach(d=>{const s=d.data(); shares[s.token]={name:s.nume,own:Number(s.actiuniProprii??s.actiuni)||0,total:Number(s.totalActiuniReprezentate??s.actiuni)||0,tip:s.tip||'',rep:s.reprezentatDe||''}; byName[(s.nume||'').trim().toLowerCase()]=s.token;});

  // Presence iniÈ›ial
  const presSnap = await sessRef.collection('presence').get();
  let presentSet=new Set(); presSnap.forEach(d=>presentSet.add(d.id));

  votesUnsub=sessRef.collection('votes').onSnapshot(async snap=>{
    const votes=[]; votedTokens=new Set();
    snap.forEach(d=>{const v=d.data(); votes.push(v); votedTokens.add(v.voterToken);});
    const pres=await sessRef.collection('presence').get(); presentSet=new Set(); pres.forEach(d=>presentSet.add(d.id));
    renderResults(agenda,shares,votes);
    renderActionari(votedTokens,presentSet);
    setLiveBar(`ConectaÈ›i (prezenÈ›Äƒ): ${presentSet.size} | Voturi primite: ${votes.length}`);
    showToast(`PrezenÈ›Äƒ actualizatÄƒ: ${presentSet.size} acÈ›ionari conectaÈ›i`);
  });
  alert('Sincronizare activÄƒ pe sesiunea: '+sid);
}
function renderResults(agenda,shares,votes){
  const tb=$('rezultate'); tb.innerHTML='';
  const tally=agenda.map(()=>({da:0,nu:0,ab:0}));
  votes.forEach(v=>{
    const wt=Number(v.weight)||(shares[v.voterToken]?.total||shares[v.voterToken]?.own||0);
    const ch=v.choices||{};
    Object.keys(ch).forEach(k=>{
      const idx=parseInt(k,10)-1; if(isNaN(idx)||idx<0||idx>=tally.length) return;
      const val=(ch[k]||'').toUpperCase(); if(val==='DA') tally[idx].da+=wt; else if(val==='NU') tally[idx].nu+=wt; else tally[idx].ab+=wt;
    });
  });
  tally.forEach((t,i)=>{const total=t.da+t.nu+t.ab; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td class="name-strong">${esc(agenda[i].titlu)}</td><td>${t.da}</td><td>${t.nu}</td><td>${t.ab}</td><td>${pct(t.da,total)}</td>`; tb.appendChild(tr);});
  $('rezumatVoturi').textContent=`Voturi Ã®nregistrate: ${votes.length} â€¢ Puncte: ${agenda.length}`;
}

/* ========== Votant (definiÈ›ie) ========== */
async function initVoter(sid,token){
  try{
    const sessRef=db.collection('sessions').doc(sid);
    const sess=await sessRef.get(); const cfg=sess.exists? sess.data():{};

    // MarcÄƒm prezenÈ›a IMEDIAT la accesare (fÄƒrÄƒ a depinde de vot)
    await sessRef.collection('presence').doc(token).set({ts:Date.now()},{merge:true});

    const start=cfg.startTime? Date.parse(cfg.startTime):null, end=cfg.endTime? Date.parse(cfg.endTime):null, now=Date.now();
    // shareholder
    let sh=await sessRef.collection('shareholders').doc(token).get();
    if(!sh.exists){ const q=await sessRef.collection('shareholders').where('token','==',token).limit(1).get(); if(q.empty){$('helloVoter').textContent='Link invalid sau sesiune indisponibilÄƒ.'; return;} sh=q.docs[0];}
    const s=sh.data();

    // situaÈ›ii speciale
    if(s.reprezentatDe){
      $('helloVoter').innerHTML='Bun venit, <b>'+esc(s.nume)+'</b> â€” <span class="badge gray">vot prin reprezentant: '+esc(s.reprezentatDe)+'</span>';
      $('intrebari').innerHTML='<div class="card">Mandatul dvs. este Ã®nregistrat ca <b>procurÄƒ</b>. Votul se exprimÄƒ de cÄƒtre reprezentant.</div>'; $('btnTrimiteVot').disabled=true; return;
    }
    const tipL=(s.tip||'').toLowerCase();
    if((tipL==='corespondenta'||tipL==='corespondenÈ›Äƒ') && s.instructiuni){
      $('helloVoter').innerHTML='Bun venit, <b>'+esc(s.nume)+'</b> â€” <span class="badge warn">vot prin corespondenÈ›Äƒ Ã®nregistrat</span>';
      $('intrebari').innerHTML='<div class="card">Votul dvs. prin corespondenÈ›Äƒ este deja Ã®nregistrat.</div>'; $('btnTrimiteVot').disabled=true; return;
    }

    // fereastrÄƒ
    if(start && now<start){ $('helloVoter').innerHTML='Bun venit, <b>'+esc(s.nume)+'</b> â€” <span class="badge gray">votul nu este Ã®ncÄƒ deschis</span>'; $('intrebari').innerHTML='<div class="card">Votul se va deschide la: '+new Date(start).toLocaleString()+'</div>'; $('btnTrimiteVot').disabled=true; return;}
    if(end && now>end){ $('helloVoter').innerHTML='Bun venit, <b>'+esc(s.nume)+'</b> â€” <span class="badge gray">perioada de vot s-a Ã®ncheiat</span>'; $('intrebari').innerHTML='<div class="card">Perioada de vot s-a Ã®ncheiat la: '+new Date(end).toLocaleString()+'</div>'; $('btnTrimiteVot').disabled=true; return;}

    // normal
    $('helloVoter').innerHTML='Bun venit, <b>'+esc(s.nume)+'</b>';
    const agSnap=await sessRef.collection('agenda').orderBy('idx').get();
    const agenda=agSnap.docs.map(d=>d.data());
    renderVoterForm(agenda);

    $('btnTrimiteVot').onclick= async ()=>{
      const choices={}; qsa('[name^=q_]').forEach(inp=>{if(inp.checked){const idx=inp.name.split('_')[1]; choices[idx]=inp.value;}});
      if(Object.keys(choices).length===0) return alert('SelectaÈ›i opÈ›iuni de vot.');
      const weight=Number(s.totalActiuniReprezentate||s.actiuniProprii||s.actiuni||0);
      try{
        await sessRef.collection('votes').doc(s.token).set({voterToken:s.token,voterName:s.nume,weight,choices,source:'online',ts:Date.now()},{merge:true});
        $('statusVot').textContent='âœ… Votul a fost Ã®nregistrat. MulÈ›umim!'; $('btnTrimiteVot').disabled=true;
      }catch(e){ console.error(e); alert('Eroare: '+e.message); }
    };
  }catch(e){ console.error(e); $('helloVoter').textContent='Eroare la Ã®ncÄƒrcare: '+e.message; }
}
function renderVoterForm(agenda){
  const root=$('intrebari'); root.innerHTML='';
  agenda.forEach(a=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<div class="agenda-title">#${a.idx}. <span class="name-strong">${esc(a.titlu)}</span></div>
      <label><input type="radio" name="q_${a.idx}" value="DA">DA</label>
      <label><input type="radio" name="q_${a.idx}" value="NU">NU</label>
      <label><input type="radio" name="q_${a.idx}" value="ABTINERE">AbÈ›inere</label>`;
    root.appendChild(div);
  });
}

/* ========== PrezenÈ›Äƒ (UI + PDF) ========== */
$('btnPresence').onclick=async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  await renderPresencePanel(sid);
  $('presencePanel').style.display='block';
  $('btnPresence').classList.add('toggled'); $('btnPresence').textContent='âœ… PrezenÈ›Äƒ afiÈ™atÄƒ'; localStorage.setItem('presenceShown','1');
};
async function renderPresencePanel(sid){
  const sessRef=db.collection('sessions').doc(sid);
  const [shSnap,vSnap,pSnap]=await Promise.all([sessRef.collection('shareholders').get(),sessRef.collection('votes').get(),sessRef.collection('presence').get()]);
  const votes=new Set(); vSnap.forEach(d=>votes.add((d.data().voterToken)));
  const present=new Set(); pSnap.forEach(d=>present.add(d.id));
  const sh=shSnap.docs.map(d=>d.data()); const byName={}; sh.forEach(s=> byName[(s.nume||'').trim().toLowerCase()]=s.token);
  const total=sh.reduce((s,a)=>s+(Number(a.actiuniProprii??a.actiuni)||0),0);
  let prez=0, prezCount=0; const tbody=$('presenceTable'); tbody.innerHTML='';
  sh.forEach((a,i)=>{
    const own=Number(a.actiuniProprii??a.actiuni)||0;
    const hasDirect=votes.has(a.token);
    const tipL=(a.tip||'').toLowerCase();
    const isCorr=(tipL==='corespondenta'||tipL==='corespondenÈ›Äƒ') && a.instructiuni;
    let repVoted=false; if(a.reprezentatDe){ const repTok=byName[(a.reprezentatDe||'').trim().toLowerCase()]; repVoted=!!repTok && votes.has(repTok); }
    const connected=present.has(a.token);
    const presentFlag = connected || isCorr || repVoted || hasDirect; // doar cazuri reale
    if(presentFlag){ prez += own; prezCount++; }
    const tip = a.reprezentatDe ? 'Prin procurÄƒ' : ((a.tip||'')||'Online');
    const obs = a.reprezentatDe ? ('Reprezentat de '+a.reprezentatDe) : (isCorr?'Vot Ã®nregistrat':'');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td class="name-strong">${esc(a.nume)}</td><td>${own}</td><td>${pct(own,total)}</td><td>${esc(tip)}</td><td>${presentFlag?'âœ… Prezent':'âŒ Absent'}</td><td>${esc(obs)}</td>`;
    tbody.appendChild(tr);
  });
  const qMin=Number($('quorumMin').value)||50; const p=(prez/total)*100; const ok=p>=qMin;
  $('presenceStats').innerHTML = `Total acÈ›iuni: <b>${total}</b> â€¢ Prezente: <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ AcÈ›ionari prezenÈ›i: <b>${prezCount}</b> / <b>${sh.length}</b> â€¢ Cvorum minim: <b>${qMin}%</b> â€¢ Cvorum atins: <b>${ok?'DA':'NU'}</b>`;
  setLiveBar(`ConectaÈ›i (prezenÈ›Äƒ): ${present.size} | Voturi primite: ${votes.size}`);
}
$('btnPresencePDF').onclick=async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const [sess,shSnap,vSnap,pSnap]=await Promise.all([sessRef.get(),sessRef.collection('shareholders').get(),sessRef.collection('votes').get(),sessRef.collection('presence').get()]);
  const cfg=sess.exists? sess.data():{}; const votes=new Set(); vSnap.forEach(d=>votes.add((d.data().voterToken)));
  const present=new Set(); pSnap.forEach(d=>present.add(d.id));
  const sh=shSnap.docs.map(d=>d.data()); const byName={}; sh.forEach(s=> byName[(s.nume||'').trim().toLowerCase()]=s.token);
  const total=sh.reduce((s,a)=>s+(Number(a.actiuniProprii??a.actiuni)||0),0);
  let prez=0, prezCount=0; let rows='';
  sh.forEach((a,i)=>{
    const own=Number(a.actiuniProprii??a.actiuni)||0;
    const hasDirect=votes.has(a.token);
    const tipL=(a.tip||'').toLowerCase();
    const isCorr=(tipL==='corespondenta'||tipL==='corespondenÈ›Äƒ') && a.instructiuni;
    let repVoted=false; if(a.reprezentatDe){ const repTok=byName[(a.reprezentatDe||'').trim().toLowerCase()]; repVoted=!!repTok && votes.has(repTok); }
    const connected=present.has(a.token);
    const presentFlag = connected || isCorr || repVoted || hasDirect;
    if(presentFlag){ prez += own; prezCount++; }
    const tip = a.reprezentatDe ? 'Prin procurÄƒ' : ((a.tip||'')||'Online');
    const obs = a.reprezentatDe ? ('Reprezentat de '+a.reprezentatDe) : (isCorr?'Vot Ã®nregistrat':'');
    rows+=`<tr><td>${i+1}</td><td><b style="color:#003399">${esc(a.nume)}</b></td><td>${own}</td><td>${pct(own,total)}</td><td>${esc(tip)}</td><td>${presentFlag?'Prezent':'Absent'}</td><td>${esc(obs)}</td></tr>`;
  });
  const html=`<html><head><title>Raport prezenÈ›Äƒ</title>
  <style>@page{size:A4;margin:14mm}body{font-family:Arial;color:#222}
  h1{color:#003399;margin:0 0 6px}.banner{background:#003399;color:#fff;padding:6px 10px;margin:10px 0}
  table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid #e5e7eb;padding:6px;text-align:left}th{background:#f3f4f6}
  .muted{color:#555}
  </style></head><body>
  <div style="display:flex;gap:12px;align-items:center"><img src="https://dh-vot.github.io/VotAGA/logo_Destine-Holding_oficial-color.png" style="height:36px"><div><h1>Destine Holding S.A. â€“ Raport prezenÈ›Äƒ AGA</h1>
  <div class="muted">Data È™edinÈ›ei: <b>${esc(cfg.date||'')}</b> â€¢ Sesiune: <b>${esc(sid)}</b></div></div></div>
  <div class="banner">Program AGA â€“ raport prezenÈ›Äƒ</div>
  <div>Total acÈ›iuni: <b>${total}</b> â€¢ Prezente: <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ AcÈ›ionari prezenÈ›i: <b>${prezCount}</b> / <b>${sh.length}</b></div>
  <h3>ListÄƒ prezenÈ›Äƒ</h3>
  <table><thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni</th><th>% total</th><th>Tip</th><th>Status</th><th>ObservaÈ›ii</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="muted" style="margin-top:10px">Elaborat cu platforma AGA â€“ Destine Holding S.A. Â© 2025</div>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.print();
};

/* ========== Raport Voturi PDF ========== */
$('btnPDF').onclick=async ()=>{
  const sid=$('sessionId').value.trim(); if(!sid) return alert('IntroduceÈ›i ID sesiune.');
  const sessRef=db.collection('sessions').doc(sid);
  const [sess,shSnap,agSnap,vSnap,pSnap]=await Promise.all([
    sessRef.get(),
    sessRef.collection('shareholders').get(),
    sessRef.collection('agenda').orderBy('idx').get(),
    sessRef.collection('votes').get(),
    sessRef.collection('presence').get()
  ]);
  const cfg=sess.exists? sess.data():{};
  const sh=shSnap.docs.map(d=>d.data()); const agenda=agSnap.docs.map(d=>d.data());
  const votes=vSnap.docs.map(d=>d.data()); const present=new Set(); pSnap.forEach(d=>present.add(d.id));

  const total=sh.reduce((s,a)=>s+(Number(a.actiuniProprii??a.actiuni)||0),0);
  const prez=votes.reduce((s,v)=>s+(Number(v.weight)||0),0);
  const prezCount = Array.from(present).length;

  const ds=cfg.startTime? toRoDate(cfg.startTime):'-', de=cfg.endTime? toRoDate(cfg.endTime):'-';
  const ts=cfg.startTime? toRoTime(cfg.startTime):'--:--', te=cfg.endTime? toRoTime(cfg.endTime):'--:--';
  const sameDay=(cfg.startTime && cfg.endTime)? (toRoDate(cfg.startTime)===toRoDate(cfg.endTime)) : true;
  const dateLine = sameDay ? `Data: <b>${ds}</b>` : `Data start: <b>${ds}</b> â€¢ Data sfÃ¢rÈ™it: <b>${de}</b>`;

  let html=`<html><head><title>Raport voturi</title>
  <style>@page{size:A4;margin:14mm}body{font-family:Arial,Helvetica,sans-serif;color:#222}
  h1{color:#003399;margin:0 0 6px}.banner{background:#003399;color:#fff;padding:6px 10px;margin:10px 0}
  table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:6px;text-align:left} th{background:#f3f4f6}
  .line{height:1px;background:#ddd;margin:10px 0}
  </style></head><body>`;
  html+=`<div style="display:flex;gap:12px;align-items:center"><img src="https://dh-vot.github.io/VotAGA/logo_Destine-Holding_oficial-color.png" style="height:36px"><div><h1>Destine Holding S.A. â€“ Raport voturi AGA</h1>
         <div>Data È™edinÈ›ei: <b>${esc(cfg.date||'')}</b> â€¢ Sesiune: <b>${esc(sid)}</b></div></div></div>
         <div class="banner">Program AGA â€“ raport voturi</div>
         <div>Total acÈ›iuni: <b>${total}</b> â€¢ Prezente (pondere voturi): <b>${prez}</b> (<b>${pct(prez,total)}</b>) â€¢ AcÈ›ionari prezenÈ›i: <b>${prezCount}</b> / <b>${sh.length}</b></div>
         <div><b>Fereastra vot:</b> ${dateLine} â€¢ Ãnceput vot: <b>${ts}</b> â€¢ SfÃ¢rÈ™it vot: <b>${te}</b></div>
         <div class="line"></div>`;

  html+=`<h3>AcÈ›ionari</h3>
         <table><thead><tr><th>#</th><th>Nume</th><th>AcÈ›iuni proprii</th><th>Reprezentate</th><th>Total ponderare</th><th>% din total</th><th>Tip</th></tr></thead><tbody>`;
  sh.sort((a,b)=> (b.totalActiuniReprezentate||b.actiuni||0)-(a.totalActiuniReprezentate||a.actiuni||0))
    .forEach((a,i)=>{const own=Number(a.actiuniProprii??a.actiuni)||0, rep=Number(a.actiuniReprezentate||0), tot=Number(a.totalActiuniReprezentate||(own+rep));
      html+=`<tr><td>${i+1}</td><td><b style="color:#003399">${esc(a.nume)}</b></td><td>${own}</td><td>${rep}</td><td>${tot}</td><td>${pct(tot,total)}</td><td>${esc(a.tip||'')}</td></tr>`;});
  html+=`</tbody></table><div class="line"></div>`;

  const tally=agenda.map(()=>({da:0,nu:0,ab:0}));
  votes.forEach(v=>{
    const wt=Number(v.weight)||0, ch=v.choices||{};
    Object.keys(ch).forEach(k=>{const idx=parseInt(k,10)-1;if(isNaN(idx)||idx<0||idx>=tally.length) return;
      const val=(ch[k]||'').toUpperCase(); if(val==='DA') tally[idx].da+=wt; else if(val==='NU') tally[idx].nu+=wt; else tally[idx].ab+=wt;});
  });
  html+=`<h3>Rezultate pe puncte</h3>
         <table><thead><tr><th>#</th><th>Punct</th><th>DA</th><th>NU</th><th>AbÈ›ineri</th><th>% DA</th></tr></thead><tbody>`;
  tally.forEach((t,i)=>{const tot=t.da+t.nu+t.ab; html+=`<tr><td>${i+1}</td><td class="name-strong">${esc(agenda[i].titlu)}</td><td>${t.da}</td><td>${t.nu}</td><td>${t.ab}</td><td>${pct(t.da,tot)}</td></tr>`;});
  html+=`</tbody></table>
         <div style="margin-top:12px;font-size:12px;color:#777">Elaborat cu platforma AGA â€“ Destine Holding S.A. Â© 2025</div>
         </body></html>`;
  const win=window.open('','_blank'); win.document.write(html); win.print();
};

/* ========== Export listÄƒ trimitere ========== */
$('btnExportLinks').onclick=()=>{
  const sid=$('sessionId').value.trim()||'AGA_2025_DH'; const base=location.href.replace(/[?#].*$/,'');
  let csv='Nume,Email,Telefon,Link votant,Link Email,Link WhatsApp\n';
  actionari.forEach(a=>{
    const link = `${base}?sid=${encodeURIComponent(sid)}&t=${encodeURIComponent(a.token||'')}`;
    const subj = encodeURIComponent('Link vot AGA â€“ Destine Holding S.A.');
    const body = encodeURIComponent(`BunÄƒ ziua ${a.nume},\n\nLinkul dvs. unic pentru vot:\n${link}\n\nSecretariatul AGA â€“ Destine Holding S.A.`);
    const mailHref = `mailto:${encodeURIComponent(a.email||'')}?subject=${subj}&body=${body}`;
    const waHref   = `https://wa.me/?text=${encodeURIComponent('Link vot AGA Destine Holding: '+link)}`;
    csv += `${escCSV(a.nume)},${escCSV(a.email||'')},${escCSV(a.tel||'')},${escCSV(link)},${escCSV(mailHref)},${escCSV(waHref)}\n`;
  });
  downloadBlob(csv,'text/csv;charset=utf-8;','trimiteri_links.csv');
  alert('FiÈ™ierul â€trimiteri_links.csvâ€ a fost generat.');
};

/* ========== Save/Load/Reset ========== */
$('btnSaveLocal').onclick=()=>{
  const data={companie:$('companie').value,date:$('dataSedintei').value,sessionId:$('sessionId').value,
  voteStart:$('voteStart').value,voteEnd:$('voteEnd').value,quorumMin:$('quorumMin').value,actionari,ordineZi};
  downloadBlob(JSON.stringify(data,null,2),'application/json','AGA_backup.json');
};
$('btnLoadLocal').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='.json';
  i.onchange=e=>{
    const f=e.target.files[0]; const r=new FileReader();
    r.onload=ev=>{
      try{const d=JSON.parse(ev.target.result);
        $('companie').value=d.companie||'Destine Holding S.A.'; $('dataSedintei').value=d.date||todayISO(); $('sessionId').value=d.sessionId||'AGA_2025_DH';
        $('voteStart').value=d.voteStart||''; $('voteEnd').value=d.voteEnd||''; $('quorumMin').value=d.quorumMin||50;
        actionari=d.actionari||[]; ordineZi=d.ordineZi||[]; renderActionari(); $('ordineContainer').innerHTML=''; ordineZi.forEach(o=>addPunct(o.titlu,o.majoritate,o.votSecret,o.observatii));
        alert('Restaurare reuÈ™itÄƒ.');
      }catch(err){ alert('Restaurare eÈ™uatÄƒ: '+err.message); }
    }; r.readAsText(f);
  }; i.click();
};
$('btnReset').onclick=()=>{ 
  if(confirm('ResetaÈ›i conÈ›inutul local?')){
    actionari=[]; ordineZi=[]; $('ordineContainer').innerHTML='';
    renderActionari();
    $('presencePanel').style.display='none';
    $('presenceTable').innerHTML='';
    $('presenceStats').innerHTML='';
    localStorage.removeItem('presenceShown');
    $('btnPresence').classList.remove('toggled');
    $('btnPresence').textContent='ğŸ‘ï¸ AfiÈ™eazÄƒ prezenÈ›a';
    showToast('Date locale resetate. PrezenÈ›a ascunsÄƒ.');
  } 
};

/* ========== Router votant (dupÄƒ definirea initVoter) ========== */
function bootVoterIfParams(){
  const url=new URL(location.href);
  const sidURL=url.searchParams.get('sid');
  const tokURL=url.searchParams.get('t');
  if(sidURL && tokURL){
    $('gateway').style.display='none';
    $('votant').style.display='block';
    setTimeout(()=>initVoter(sidURL,tokURL),100);
  }
}
document.addEventListener('DOMContentLoaded',bootVoterIfParams);
bootVoterIfParams();

/* ========== UI init ========== */
if(!$('dataSedintei').value) $('dataSedintei').value=todayISO();
})();
</script>
</body>
</html>
