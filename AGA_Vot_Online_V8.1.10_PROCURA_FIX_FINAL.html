<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGA Destine Holding – V8.1.10 PROCURA FIX FINAL (LOCAL)</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #ffffff;
        margin: 0;
        padding: 0;
        color: #222;
    }
    h1, h2, h3 {
        margin: 0;
        padding: 0;
    }
    /* --- HEADER --- */
    #header {
        text-align: center;
        padding: 30px 10px 20px 10px;
        border-bottom: 3px solid #003399;
    }
    #header img {
        width: 260px;
        margin-bottom: 15px;
    }
    #header h1 {
        font-size: 26px;
        font-weight: bold;
        color: #003399;
    }
    #header h2 {
        font-size: 16px;
        margin-top: 8px;
        color: #444;
    }
    /* --- Container principal --- */
    .container {
        max-width: 980px;
        margin: 30px auto;
        padding: 20px;
        background: #f5f7fb;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.08);
        animation: fadeInUp .55s ease-out;
    }
    @keyframes fadeInUp {
        from { opacity:0; transform:translateY(22px); }
        to { opacity:1; transform:translateY(0); }
    }
    /* --- Butoane --- */
    button {
        padding: 8px 14px;
        background: #003399;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.25s ease, transform 0.1s;
        margin: 4px 4px 4px 0;
        font-size: 13px;
    }
    button:hover {
        background: #0055ff;
    }
    button:active {
        transform: scale(0.97);
    }
    button.clicked {
        background: #1a9900 !important;
    }
    /* --- Tabele --- */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
        background: white;
    }
    th {
        background: #003399;
        color: white;
        padding: 8px;
        font-size: 13px;
        text-align: left;
    }
    td {
        padding: 7px 8px;
        border-bottom: 1px solid #ddd;
        font-size: 13px;
    }
    tr:nth-child(even) td {
        background: #f9fafc;
    }
    /* Linie secțiune */
    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-top: 26px;
        color: #003399;
        border-left: 6px solid #003399;
        padding-left: 10px;
    }
    /* Form input */
    input, select {
        padding: 6px 8px;
        width: 100%;
        border-radius: 6px;
        border: 1px solid #bbb;
        margin-top: 6px;
        font-size: 13px;
    }
    .row {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }
    .col {
        flex: 1;
    }
    .hidden {
        display: none !important;
    }
    /* --- Pagina votant --- */
    #paginaVotant {
        max-width: 700px;
        margin: 20px auto;
        background: #fffefa;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #003399;
        animation: fadeInUp .55s ease-out;
    }
    .optiuni-vot {
        display: flex;
        justify-content: flex-start;
        gap: 18px;
        margin: 6px 0 12px 0;
        align-items: center;
    }
    .optiuni-vot label {
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .small {
        font-size: 12px;
        color: #555;
    }
</style>
</head>

<body>

<div id="header">
    <img src="logo_Destine-Holding_oficial-color.png" alt="Logo Destine Holding">
    <h1>Destine Holding S.A.</h1>
    <h2>Program de vot online – Adunarea Generală a Acționarilor</h2>
</div>

<!-- PAGINA START (organizator) -->
<div id="paginaStart" class="container">
    <h2 style="margin-bottom:15px;">Acces organizator</h2>

    <label>Introduceți parola:</label>
    <input type="password" id="parolaOrganizator" placeholder="Parola (implicit: DH2026)">
    <br><br>
    <button onclick="verificaParola()">Intră ca organizator</button>
    <button onclick="schimbaParola()">Schimbă parola</button>

    <h3 style="margin-top:30px;">Mod Votant</h3>
    <p class="small">
        Dacă accesați cu link personal <code>?sid=...&amp;t=...</code>, intrați direct în modul votant.
        Această versiune este locală (fără Firestore) – pentru vot multiplu pe dispozitive diferite este nevoie de versiunea online.
    </p>
</div>

<!-- PAGINA ORGANIZATOR -->
<div id="organizator" class="container hidden">

    <div class="section-title">Setări AGA</div>

    <div class="row">
        <div class="col">
            <label>Companie</label>
            <input id="numeCompanie" value="Destine Holding S.A.">
        </div>
        <div class="col">
            <label>Data ședinței</label>
            <input id="dataSedintei" type="date">
        </div>
        <div class="col">
            <label>ID sesiune</label>
            <input id="idSesiune" value="AGA_2025_DH">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>Quorum minim (%)</label>
            <input id="quorumMinim" type="number" value="50">
        </div>
        <div class="col">
            <label>Ora început vot</label>
            <input id="oraStart" type="time" value="11:00">
        </div>
        <div class="col">
            <label>Ora sfârșit vot</label>
            <input id="oraEnd" type="time" value="16:00">
        </div>
    </div>

    <div class="section-title">Acționari & Prezență</div>

    <button onclick="document.getElementById('csvAct').click()">Importă acționari (CSV)</button>
    <input type="file" id="csvAct" accept=".csv" class="hidden" onchange="incarcaCSVActiuni(event)">

    <button onclick="exportaCSVActiuni()">Exportă acționari</button>
    <button onclick="genereazaTokenuri()">Generează tokenuri</button>

    <table id="tabelAct"></table>

    <button onclick="marcheazaTotiPrezent()">Marchează toți prezenți</button>
    <button onclick="golestePrezenta()">Golește prezența</button>

    <div class="section-title">Ordinea de zi</div>

    <button onclick="document.getElementById('csvOz').click()">Importă Ordinea de zi (CSV)</button>
    <input type="file" id="csvOz" accept=".csv" class="hidden" onchange="incarcaCSVOZ(event)">

    <button onclick="exportaCSVOZ()">Exportă Ordinea de zi</button>
    <button onclick="adaugaPunct()">Adaugă punct manual</button>

    <div id="listaPuncte"></div>

    <div class="section-title">Rapoarte & copii</div>

    <button onclick="exportaRaportPrezentaPDF()">Raport prezență PDF</button>
    <button onclick="exportaRaportPDF()">Raport voturi PDF</button>

    <button onclick="salveazaLocal()">Salvează local</button>
    <button onclick="incarcaDinCopie()">Încarcă din copie</button>
    <button onclick="resetTotal()">Reset total</button>
</div>

<!-- PAGINA VOTANT -->
<div id="paginaVotant" class="hidden">
    <h2 style="color:#003399; margin-bottom:5px;">Votare – <span id="numeVotant"></span></h2>
    <p class="small" id="tipVotantInfo"></p>
    <div id="listaVotPuncte"></div>
    <button onclick="trimiteVotul()" style="margin-top:15px;">Trimite votul</button>
</div>

<script>
/* ---------------------------------------------------------
   SECȚIUNEA 1 – VARIABILE GLOBALE
--------------------------------------------------------- */
let actionari = [];            // lista acționari
let puncte = [];               // lista ordinea de zi
let parolaCorecta = "DH2026"; // parola default
let tokenCurent = null;        // token votant
let actiuniTotale = 0;         // total acțiuni
let voturi = {};               // voturile per acționar per punct (online + procură generală)

/* Mic helper */
function tipNormalizat(tipRaw) {
    const t = (tipRaw || "").toLowerCase();
    if (t.includes("coresp")) return "Corespondență";
    if (t.includes("special")) return "Procura specială";
    if (t.includes("general")) return "Procura generală";
    return "Online";
}

/* ---------------------------------------------------------
   SECȚIUNEA 2 – AUTENTIFICARE ORGANIZATOR
--------------------------------------------------------- */
function verificaParola() {
    const p = document.getElementById("parolaOrganizator").value.trim();
    if (p === parolaCorecta) {
        document.getElementById("paginaStart").classList.add("hidden");
        document.getElementById("organizator").classList.remove("hidden");
    } else {
        alert("Parolă incorectă!");
    }
}

function schimbaParola() {
    const noua = prompt("Introduceți noua parolă:");
    if (noua && noua.trim() !== "") {
        parolaCorecta = noua.trim();
        alert("Parola a fost schimbată cu succes!");
    }
}

/* ---------------------------------------------------------
   SECȚIUNEA 3 – IMPORT / EXPORT ACȚIONARI CSV
--------------------------------------------------------- */
function incarcaCSVActiuni(ev) {
    const file = ev.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        actionari = [];
        actiuniTotale = 0;

        for (let i=1; i<lines.length; i++) {
            const cols = lines[i].split(",");
            if (cols.length < 4) continue;

            const nume = cols[0].trim();
            const act = parseInt(cols[1].trim() || "0");
            const tel = cols[2].trim();
            const em = cols[3].trim();
            const procura = (cols[4] || "").trim();
            const instr = (cols[5] || "").trim();
            const tip = (cols[6] || "Online").trim();

            if (!nume) continue;

            actionari.push({
                nume: nume,
                actiuni: act,
                telefon: tel,
                email: em,
                procura: procura,
                instructiuni: instr,
                tip: tip,
                prezent: (tipNormalizat(tip) === "Corespondență"),
                token: "",
                aVotat: false
            });

            actiuniTotale += act;
        }

        actualizeazaTabelAct();
        alert("Acționarii au fost încărcați.");
    };
    reader.readAsText(file);
}

function exportaCSVActiuni() {
    let csv = "Nume,Actiuni,Telefon,Email,ProcuraPentru,InstructiuniVot,Tip,Token\n";
    actionari.forEach(a => {
        csv += [
            a.nume,
            a.actiuni,
            a.telefon,
            a.email,
            a.procura || "",
            a.instructiuni || "",
            a.tip || "Online",
            a.token || ""
        ].join(",") + "\n";
    });
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "actionari_export.csv";
    a.click();
    URL.revokeObjectURL(url);
}

function actualizeazaTabelAct() {
    actionari.sort((a,b) => a.nume.localeCompare(b.nume,'ro'));
    let html = `
        <tr>
            <th>#</th>
            <th>Nume</th>
            <th>Acțiuni</th>
            <th>Telefon</th>
            <th>Email</th>
            <th>Procură</th>
            <th>Tip</th>
            <th>Prezență</th>
            <th>Vot</th>
            <th>Token</th>
            <th>Link votant</th>
        </tr>
    `;

    actionari.forEach((ac, idx) => {
        const tipAfis = tipNormalizat(ac.tip);
        const prez = ac.prezent ? "Prezent" : "Absent";
        const voted = ac.aVotat || (ac.instructiuni && ac.instructiuni.trim()) ? "Votat" : "Nevotat";
        html += `
            <tr>
                <td>${idx+1}</td>
                <td>${ac.nume}</td>
                <td>${ac.actiuni}</td>
                <td>${ac.telefon}</td>
                <td>${ac.email}</td>
                <td>${ac.procura || ""}</td>
                <td>${tipAfis}</td>
                <td>${prez}</td>
                <td>${voted}</td>
                <td>${ac.token || ""}</td>
                <td>${ac.token ? `<button onclick="copiazaLink('${ac.token}')">Copiază</button>` : ""}</td>
            </tr>
        `;
    });

    document.getElementById("tabelAct").innerHTML = html;
}

function marcheazaTotiPrezent() {
    actionari.forEach(a => a.prezent = true);
    actualizeazaTabelAct();
}

function golestePrezenta() {
    actionari.forEach(a => a.prezent = false);
    actualizeazaTabelAct();
}

/* ---------------------------------------------------------
   SECȚIUNEA 4 – TOKENURI & LINKURI
--------------------------------------------------------- */
function genereazaTokenuri() {
    actionari.forEach(a => {
        a.token = Math.random().toString(36).substring(2,8);
    });
    actualizeazaTabelAct();
    alert("Tokenurile au fost generate.");
}

function copiazaLink(token) {
    const base = window.location.href.split("?")[0];
    const sid = document.getElementById("idSesiune").value || "AGA_2025_DH";
    const link = `${base}?sid=${encodeURIComponent(sid)}&t=${encodeURIComponent(token)}`;
    navigator.clipboard.writeText(link).then(()=>{
        alert("Link copiat:\n" + link);
    });
}

/* ---------------------------------------------------------
   SECȚIUNEA 5 – ORDINEA DE ZI
--------------------------------------------------------- */
function incarcaCSVOZ(ev) {
    const file = ev.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        puncte = [];

        for (let i=1; i<lines.length; i++) {
            const cols = lines[i].split(",");
            if (cols.length < 1) continue;
            const titlu = (cols[0] || "").trim();
            const obs = (cols[1] || "").trim();
            if (!titlu) continue;
            puncte.push({
                id: puncte.length + 1,
                titlu: titlu,
                majoritate: "Simpla",
                secret: false,
                observatii: obs
            });
        }

        afiseazaPuncte();
        alert("Ordinea de zi a fost încărcată.");
    };
    reader.readAsText(file);
}

function exportaCSVOZ() {
    let csv = "Titlu,Observatii\n";
    puncte.forEach(p => {
        csv += `${p.titlu},${p.observatii || ""}\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ordine_zi_export.csv";
    a.click();
    URL.revokeObjectURL(url);
}

function afiseazaPuncte() {
    let html = "";
    puncte.forEach((p, idx) => {
        html += `
        <div style="background:#fff; padding:12px; margin-top:12px; border-radius:8px; border-left:4px solid #003399;">
            <b>Punct #${idx+1}</b><br>
            <label>Titlu:</label>
            <input value="${p.titlu}" onchange="puncte[${idx}].titlu=this.value">

            <label>Majoritate:</label>
            <select onchange="puncte[${idx}].majoritate=this.value">
                <option value="Simpla" ${p.majoritate==="Simpla"?'selected':''}>Majoritate simplă (>50%)</option>
                <option value="Absoluta" ${p.majoritate==="Absoluta"?'selected':''}>Majoritate absolută (>50% din total acțiuni)</option>
            </select>

            <label>Vot secret:</label>
            <select onchange="puncte[${idx}].secret=(this.value==='Da')">
                <option ${p.secret?'':'selected'}>Nu</option>
                <option ${p.secret?'selected':''}>Da</option>
            </select>

            <label>Observații:</label>
            <input value="${p.observatii || ""}" onchange="puncte[${idx}].observatii=this.value">
        </div>`;
    });
    document.getElementById("listaPuncte").innerHTML = html;
}

function adaugaPunct() {
    puncte.push({
        id: puncte.length + 1,
        titlu: "Punct nou",
        majoritate: "Simpla",
        secret: false,
        observatii: ""
    });
    afiseazaPuncte();
}

/* ---------------------------------------------------------
   SECȚIUNEA 6 – PAGINA VOTANT
--------------------------------------------------------- */
function initVotant() {
    const url = new URL(window.location.href);
    const token = url.searchParams.get("t");
    const sid = url.searchParams.get("sid");
    if (!token || !sid) return; // nu e link votant

    tokenCurent = token;
    const acc = actionari.find(a => a.token === token);
    if (!acc) {
        alert("Link votant invalid sau acționarul nu a fost încă încărcat.");
        return;
    }

    // Ascundem organizatorul, arătăm votantul
    document.getElementById("paginaStart").classList.add("hidden");
    document.getElementById("organizator").classList.add("hidden");
    document.getElementById("paginaVotant").classList.remove("hidden");

    document.getElementById("numeVotant").innerText = acc.nume;
    document.getElementById("tipVotantInfo").innerText =
        "Tip vot: " + tipNormalizat(acc.tip) +
        (acc.procura ? (" • Reprezentant: " + acc.procura) : "");

    // Prezență: online -> prezent; corespondenta -> deja prezent; procură generală -> și cei reprezentați devin prezenți
    acc.prezent = true;
    actionari
        .filter(a => a.procura === acc.nume)
        .forEach(a => a.prezent = true);
    actualizeazaTabelAct();

    // Construim întrebările
    let html = "";
    puncte.forEach(p => {
        html += `
            <div style="margin-top:12px; border-bottom:1px solid #ddd; padding-bottom:8px;">
                <b>${p.id}. ${p.titlu}</b>
                <div class="optiuni-vot">
                    <label><input type="radio" name="pct_${p.id}" value="DA"> DA</label>
                    <label><input type="radio" name="pct_${p.id}" value="NU"> NU</label>
                    <label><input type="radio" name="pct_${p.id}" value="ABTINERE"> Abținere</label>
                </div>
                <span class="small">${p.secret ? "Vot secret" : ""}</span>
            </div>`;
    });
    document.getElementById("listaVotPuncte").innerHTML = html;
}

/* Interpretare instrucțiuni vot (ex. "1:DA;2:NU;3:ABTINERE") */
function parseInstr(instr, idPunct) {
    if (!instr) return null;
    const parts = instr.split(";");
    for (let p of parts) {
        const [nr, val] = p.split(":");
        if (!nr || !val) continue;
        if (parseInt(nr) === idPunct) return val.trim().toUpperCase();
    }
    return null;
}

/* ---------------------------------------------------------
   SECȚIUNEA 7 – TRIMITERE VOT (online + procură generală + specială)
--------------------------------------------------------- */
function trimiteVotul() {
    const acc = actionari.find(a => a.token === tokenCurent);
    if (!acc) {
        alert("Acționarul nu a fost găsit.");
        return;
    }

    if (!voturi[acc.nume]) voturi[acc.nume] = {};

    puncte.forEach(p => {
        const v = document.querySelector(`input[name='pct_${p.id}']:checked`);
        voturi[acc.nume][p.id] = v ? v.value : "ABTINERE";
    });

    acc.aVotat = true;

    // Pentru mandanți cu procura generală -> preiau votul reprezentantului
    actionari
        .filter(a => a.procura === acc.nume && tipNormalizat(a.tip) === "Procura generală")
        .forEach(a => {
            a.aVotat = true;
            if (!voturi[a.nume]) voturi[a.nume] = {};
            puncte.forEach(p => {
                const instr = parseInstr(a.instructiuni, p.id);
                voturi[a.nume][p.id] = instr || voturi[acc.nume][p.id];
            });
        });

    alert("Vot trimis.");
    actualizeazaTabelAct();
}

/* ---------------------------------------------------------
   SECȚIUNEA 8 – SALVARE LOCALĂ / ÎNCĂRCARE DIN COPIE / RESET
--------------------------------------------------------- */
function salveazaLocal() {
    const data = {
        actionari: actionari,
        puncte: puncte,
        voturi: voturi,
        meta: {
            companie: document.getElementById("numeCompanie").value,
            dataSedintei: document.getElementById("dataSedintei").value,
            idSesiune: document.getElementById("idSesiune").value,
            quorumMinim: document.getElementById("quorumMinim").value,
            oraStart: document.getElementById("oraStart").value,
            oraEnd: document.getElementById("oraEnd").value
        }
    };

    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "AGA_sesiune_backup.json";
    a.click();
    URL.revokeObjectURL(url);
}

function incarcaDinCopie() {
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = ".json";
    inp.onchange = function(ev) {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                actionari = data.actionari || [];
                puncte = data.puncte || [];
                voturi = data.voturi || {};
                actiuniTotale = actionari.reduce((s,a)=>s+(a.actiuni||0),0);

                if (data.meta) {
                    document.getElementById("numeCompanie").value = data.meta.companie || "Destine Holding S.A.";
                    document.getElementById("dataSedintei").value = data.meta.dataSedintei || "";
                    document.getElementById("idSesiune").value = data.meta.idSesiune || "AGA_2025_DH";
                    document.getElementById("quorumMinim").value = data.meta.quorumMinim || "50";
                    document.getElementById("oraStart").value = data.meta.oraStart || "11:00";
                    document.getElementById("oraEnd").value = data.meta.oraEnd || "16:00";
                }

                actualizeazaTabelAct();
                afiseazaPuncte();
                alert("Datele au fost încărcate din copie.");
            } catch(e) {
                alert("Eroare la încărcarea copiei.");
            }
        };
        reader.readAsText(file);
    };
    inp.click();
}

function resetTotal() {
    if (!confirm("Sigur doriți să resetați complet sesiunea AGA?")) return;
    actionari = [];
    puncte = [];
    voturi = {};
    actiuniTotale = 0;
    document.getElementById("tabelAct").innerHTML = "";
    document.getElementById("listaPuncte").innerHTML = "";
    alert("Sesiune resetată.");
}

/* ---------------------------------------------------------
   SECȚIUNEA 9 – RAPORT PREZENȚĂ (PDF)
--------------------------------------------------------- */
function exportaRaportPrezentaPDF() {
    const total = actiuniTotale || actionari.reduce((s,a)=>s+(a.actiuni||0),0);
    const prezenti = actionari.filter(a=>a.prezent);
    const actPrez = prezenti.reduce((s,a)=>s+(a.actiuni||0),0);
    const qmin = parseFloat(document.getElementById("quorumMinim").value || "50");
    const cvorumAtins = total ? (actPrez*100/total) >= qmin : false;

    let rows = "";
    actionari.slice().sort((a,b)=>a.nume.localeCompare(b.nume,'ro')).forEach((a,i)=>{
        const tip = tipNormalizat(a.tip);
        const prez = a.prezent?"DA":"NU";
        const votat = (a.aVotat || (a.instructiuni && a.instructiuni.trim())) ? "DA":"NU";
        const obs = a.procura ? ("Reprezentat / reprezentant: " + a.procura) : "";
        rows += `
            <tr>
                <td>${i+1}</td>
                <td>${a.nume}</td>
                <td>${a.actiuni}</td>
                <td>${total?((a.actiuni*100/total).toFixed(2)+"%"):"0.00%"}</td>
                <td>${tip}</td>
                <td>${prez}</td>
                <td>${votat}</td>
                <td>${obs}</td>
            </tr>`;
    });

    const win = window.open("", "_blank");
    win.document.write(`
        <html><head><meta charset="UTF-8"><title>Raport prezență AGA</title>
        <style>
            body{font-family:Arial,sans-serif;font-size:12px;margin:20px;}
            h1,h2,h3{color:#003399;margin:0 0 8px 0;}
            table{width:100%;border-collapse:collapse;margin-top:10px;}
            th,td{border:1px solid #ddd;padding:5px;font-size:11px;}
            th{background:#003399;color:white;}
        </style>
        </head><body>
        <h1>Destine Holding S.A.</h1>
        <h2>Raport prezență AGA</h2>
        <p>Data ședinței: ${document.getElementById("dataSedintei").value || "-"}</p>
        <p>Sesiune: ${document.getElementById("idSesiune").value || "-"}</p>
        <p>Total acțiuni: ${total} • Prezente: ${actPrez} (${total? (actPrez*100/total).toFixed(2)+"%":"0.00%"})<br>
           Acționari prezenți: ${prezenti.length} / ${actionari.length}<br>
           Quorum minim: ${qmin}% • Cvorum atins: ${cvorumAtins? "DA":"NU"}</p>
        <table>
            <tr>
                <th>#</th><th>Nume acționar</th><th>Acțiuni</th><th>% total</th>
                <th>Tip prezență</th><th>Prezent</th><th>Votat</th><th>Observații</th>
            </tr>
            ${rows}
        </table>
        </body></html>
    `);
    win.document.close();
    win.focus();
    win.print();
}

/* ---------------------------------------------------------
   SECȚIUNEA 10 – RAPORT VOTURI (PDF) – FORMULA NOUĂ
--------------------------------------------------------- */
function exportaRaportPDF() {
    const total = actiuniTotale || actionari.reduce((s,a)=>s+(a.actiuni||0),0);

    // Tabel acționari (Nume, acțiuni, %, tip, prezent, votat)
    let rowsAcc = "";
    actionari.slice().sort((a,b)=>a.nume.localeCompare(b.nume,'ro')).forEach((a,i)=>{
        const tip = tipNormalizat(a.tip);
        const prez = a.prezent?"DA":"NU";
        const votat = (a.aVotat || (a.instructiuni && a.instructiuni.trim())) ? "DA":"NU";
        rowsAcc += `
            <tr>
                <td>${i+1}</td>
                <td>${a.nume}</td>
                <td>${a.actiuni}</td>
                <td>${total?((a.actiuni*100/total).toFixed(2)+"%"):"0.00%"}</td>
                <td>${tip}</td>
                <td>${prez}</td>
                <td>${votat}</td>
            </tr>`;
    });

    // Rezultate pe puncte – FORMULA NOUĂ
    let rowsP = "";
    puncte.slice().sort((a,b)=>a.id-b.id).forEach(p=>{
        let DA = 0, NU = 0, ABT = 0;

        actionari.forEach(a=>{
            let v = null;

            // 1) Dacă există vot online/procură generată în 'voturi'
            if (voturi[a.nume] && voturi[a.nume][p.id]) {
                v = voturi[a.nume][p.id];
            }

            // 2) Dacă există instrucțiuni speciale (coresp / procură specială)
            const instr = parseInstr(a.instructiuni, p.id);
            if (instr) v = instr;

            if (!v) v = "ABTINERE";

            if (v === "DA") DA += a.actiuni;
            else if (v === "NU") NU += a.actiuni;
            else ABT += a.actiuni;
        });

        const tot = DA + NU + ABT;
        const pDA = tot ? ((DA*100/tot).toFixed(2)+"%") : "0.00%";

        let admis = "Respins";
        if (tot > 0) {
            if (p.majoritate === "Absoluta") {
                if (DA > (actiuniTotale/2)) admis = "Admis";
            } else {
                const valPct = DA*100/tot;
                if (valPct > 50 && DA > NU) admis = "Admis";
            }
        }

        rowsP += `
            <tr>
                <td>${p.id}</td>
                <td>${p.titlu}</td>
                <td>${DA}</td>
                <td>${NU}</td>
                <td>${ABT}</td>
                <td>${pDA}</td>
                <td>${admis}</td>
            </tr>`;
    });

    const win = window.open("", "_blank");
    win.document.write(`
        <html><head><meta charset="UTF-8"><title>Raport voturi AGA</title>
        <style>
            body{font-family:Arial,sans-serif;font-size:12px;margin:20px;}
            h1,h2,h3{color:#003399;margin:0 0 8px 0;}
            table{width:100%;border-collapse:collapse;margin-top:10px;}
            th,td{border:1px solid #ddd;padding:5px;font-size:11px;}
            th{background:#003399;color:white;}
        </style>
        </head><body>
        <h1>Destine Holding S.A.</h1>
        <h2>Raport voturi AGA</h2>
        <p>Data ședinței: ${document.getElementById("dataSedintei").value || "-"}</p>
        <p>Sesiune: ${document.getElementById("idSesiune").value || "-"}</p>
        <p>Fereastră vot: Data: ${document.getElementById("dataSedintei").value || "-"},
           Început vot: ${document.getElementById("oraStart").value || "-"},
           Sfârșit vot: ${document.getElementById("oraEnd").value || "-"}</p>

        <h3>Acționari</h3>
        <table>
            <tr>
                <th>#</th><th>Nume acționar</th><th>Acțiuni</th><th>% din total</th>
                <th>Tip vot</th><th>Prezent</th><th>Votat</th>
            </tr>
            ${rowsAcc}
        </table>

        <h3>Rezultate pe puncte</h3>
        <table>
            <tr>
                <th>#</th><th>Punct</th><th>DA (acțiuni)</th>
                <th>NU (acțiuni)</th><th>Abțineri (acțiuni)</th>
                <th>% DA</th><th>Rezultat</th>
            </tr>
            ${rowsP}
        </table>
        </body></html>
    `);
    win.document.close();
    win.focus();
    win.print();
}

/* ---------------------------------------------------------
   SECȚIUNEA 11 – INIT
--------------------------------------------------------- */
window.addEventListener("DOMContentLoaded", ()=>{
    // Setăm data de azi implicit
    const d = new Date();
    const z = n => String(n).padStart(2,"0");
    const azi = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    const ds = document.getElementById("dataSedintei");
    if (ds && !ds.value) ds.value = azi;

    // Dacă este link de votant, încercăm init votant
    initVotant();
});
</script>

</body>
</html>
