<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AGA Destine Holding ‚Äì V6 LIVE (Organizer & Votant) ‚Ä¢ Firestore</title>
  <meta name="description" content="PlatformƒÉ single-file pentru AGA: Organizator (parolƒÉ), Votant (link unic), vot ponderat, export PDF/JSON/CSV, Firestore live, monitorizare sesiune, toggle TEST/PROD.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    :root{ --blue:#0d47a1; --blue600:#1e40af; --green:#0f9d58; --red:#c62828; --amber:#f59e0b;
           --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.06);}
    *{box-sizing:border-box} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:#0b1220;padding:18px}
    .container{max-width:1150px;margin:0 auto}
    header{display:flex;gap:14px;align-items:center;background:linear-gradient(135deg,var(--blue),var(--blue600));color:#fff;
      border-radius:var(--radius);padding:22px;box-shadow:var(--shadow)}
    .title{font-weight:800;font-size:1.25rem}
    .badge{padding:6px 10px;border-radius:999px;background:#ffffff1a;border:1px solid #ffffff3a;font-weight:700}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-top:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px} .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    label{font-weight:700} input,select,button,textarea{font-family:inherit;font-size:1rem}
    .input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border:0;border-radius:12px;cursor:pointer;
      background:var(--blue);color:#fff;font-weight:800;box-shadow:var(--shadow);transition:.2s transform}
    .btn.secondary{background:#11182714;color:#0b1220} .btn.green{background:var(--green)} .btn.red{background:var(--red)}
    .btn.amber{background:var(--amber);color:#111827} .btn:active{transform:translateY(1px)} .hidden{display:none !important}
    .muted{color:var(--muted)} .small{font-size:.92rem} table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eef1f5;text-align:left}
    .chip{padding:6px 10px;border-radius:999px;background:#0b122010;border:1px dashed #d1d5db}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .box{background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:14px;text-align:center}
    .kpi .val{font-size:1.3rem;font-weight:800} footer{margin-top:12px;text-align:center}
    @media (max-width:860px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr} .kpi{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div style="font-size:40px">üó≥Ô∏è</div>
    <div>
      <div class="title">AGA Destine Holding ‚Äî V6 LIVE</div>
      <div class="small">Single-file ‚Ä¢ Organizer & Votant ‚Ä¢ Firestore Live ‚Ä¢ Build: <span id="buildTs"></span></div>
    </div>
    <div style="margin-left:auto" class="row">
      <span class="badge" id="envBadge">TEST</span>
      <span class="badge" id="roleBadge">‚Äî</span>
    </div>
  </header>

  <section class="card" id="secGate">
    <h2>Acces</h2>
    <div class="grid cols-2">
      <div>
        <h3>Mod Votant</h3>
        <p class="small muted">DacƒÉ ave»õi un link cu <code>?t=TOKEN</code>, intra»õi direct. FƒÉrƒÉ cont Google.</p>
        <div class="row"><a class="btn secondary" id="btnSampleVoter">Exemplu link votant</a></div>
      </div>
      <div>
        <h3>Mod Organizator</h3>
        <label>ParolƒÉ</label>
        <input id="orgPass" class="input" placeholder="Introduce»õi parola" type="password">
        <div class="row">
          <button class="btn" id="btnOrgLogin">IntrƒÉ ca Organizator</button>
          <button class="btn amber" id="btnToggleEnv">ComutƒÉ Mod (TEST‚ÜîPROD)</button>
        </div>
        <div class="small muted">ParolƒÉ implicitƒÉ: <code>DESTINE2025</code>. Mod implicit: <b>TEST</b>.</div>
      </div>
    </div>
  </section>

  <section class="card hidden" id="secOrganizer">
    <h2>Mod Organizator</h2>
    <div class="grid cols-3">
      <div class="chip">Proiect Firestore: <b id="projectName">destineaga</b></div>
      <div class="chip">Sesiune: <b id="meetingKey"></b></div>
      <div class="chip">Sincronizare: <b id="syncStatus">offline</b></div>
    </div>

    <h3 style="margin-top:16px">1) Import date</h3>
    <div class="grid cols-3">
      <div>
        <label>Ac»õionari (CSV)</label>
        <input type="file" id="fileShareholders" accept=".csv" class="input"/>
        <div class="small muted">Coloane: id,name,shares,email</div>
      </div>
      <div>
        <label>Ordinea de zi (JSON)</label>
        <input type="file" id="fileAgenda" accept=".json" class="input"/>
        <div class="small muted">Format: [{"id":"p1","title":"..."}, ‚Ä¶]</div>
      </div>
      <div class="row" style="align-items:flex-end">
        <button class="btn secondary" id="btnLoadDemos">√éncarcƒÉ demo</button>
        <button class="btn" id="btnClearAll">»òterge tot</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ac»õionari importa»õi</h3>
        <table id="tblShareholders"><thead><tr><th>#</th><th>ID</th><th>Nume</th><th>Ac»õiuni</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ordinea de zi</h3>
        <table id="tblAgenda"><thead><tr><th>#</th><th>ID</th><th>Punct</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <h3>2) Linkuri unice pentru vot</h3>
    <div class="row">
      <button class="btn green" id="btnGenerateLinks">GenereazƒÉ linkuri</button>
      <button class="btn secondary" id="btnCopyAll">CopiazƒÉ lista</button>
    </div>
    <div class="card" id="linksBox" style="max-height:240px;overflow:auto;margin-top:10px">
      <table id="tblLinks"><thead><tr><th>#</th><th>Nume</th><th>Link unic</th><th>Copy</th></tr></thead><tbody></tbody></table>
    </div>

    <h3>3) Monitorizare sesiune live</h3>
    <div class="kpi">
      <div class="box"><div class="small muted">Total ac»õionari</div><div class="val" id="kTotalSh">0</div></div>
      <div class="box"><div class="small muted">Prezen»õi</div><div class="val" id="kPresent">0</div></div>
      <div class="box"><div class="small muted">Voturi exprimate</div><div class="val" id="kCast">0</div></div>
      <div class="box"><div class="small muted">Cronometru</div><div class="val" id="kTimer">00:00</div></div>
    </div>

    <div class="grid cols-2" style="margin-top:12px">
      <div class="card" style="border:1px dashed #e5e7eb"><canvas id="liveChart" height="200"></canvas></div>
      <div class="card" style="border:1px dashed #e5e7eb">
        <h3>Ultimele voturi</h3>
        <table id="tblRecent"><thead><tr><th>Timp</th><th>Votant</th><th>Punct</th><th>Op»õiune</th><th>Pondere</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <h3>4) Export</h3>
    <div class="row">
      <button class="btn secondary" id="btnExportJSON">Export JSON</button>
      <button class="btn secondary" id="btnExportCSV">Export CSV</button>
      <button class="btn secondary" id="btnExportPDF">Export PDF</button>
      <span class="small muted">ExportƒÉ rezultatele din Firestore.</span>
    </div>
  </section>

  <section class="card hidden" id="secVoter">
    <h2>Vot AGA</h2>
    <div class="grid cols-2">
      <div class="chip">Token: <b id="voterToken">‚Äî</b></div>
      <div class="chip">Pondere: <b id="voterWeight">1</b></div>
    </div>
    <p class="small muted">Alege»õi DA / NU / Ab»õinere pentru fiecare punct. Trimiterea e anonimƒÉ (hash de token).</p>
    <div id="voterAgenda"></div>
    <div class="row" style="margin-top:10px"><button class="btn green" id="btnSubmitVote">Trimite votul</button></div>
    <div id="voterThanks" class="hidden" style="margin-top:10px"><span class="small" style="color:var(--green);font-weight:800">Vot transmis. Mul»õumim!</span></div>
  </section>

  <footer class="card">
    <div class="small muted">Sincronizare activƒÉ ‚Äì Firestore DestineAGA (live) ‚Ä¢ <span id="footerEnv">TEST</span></div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  const $ = sel => document.querySelector(sel);
  const fmt2 = n => String(n).padStart(2,'0');
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const db64 = s => decodeURIComponent(escape(atob(s)));

  $('#buildTs').textContent = new Date().toLocaleString();

  let ENV = localStorage.getItem('aga_env') || 'TEST';
  function paintEnv(){ $('#envBadge').textContent = ENV; $('#footerEnv').textContent = ENV; localStorage.setItem('aga_env', ENV); }
  paintEnv();
  $('#btnToggleEnv').addEventListener('click', ()=>{ ENV = (ENV==='TEST'?'PROD':'TEST'); paintEnv(); alert('Mod setat pe: '+ENV); });

  const PROJECT_NAME = 'destineaga';
  const ORG_PASSWORD = 'DESTINE2025';
  $('#projectName').textContent = PROJECT_NAME;

  let firebaseApp, db, fs_mod;
  async function ensureFirebase(){
    if(firebaseApp) return;
    const fb = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    fs_mod = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
    const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDbVELVBtmoS1m0761QQ2kI5Cvsjc4cjwc",
  authDomain: "destineaga.firebaseapp.com",
  projectId: "destineaga",
  storageBucket: "destineaga.firebasestorage.app",
  messagingSenderId: "997907169795",
  appId: "1:997907169795:web:e06e62d522a13b01e48436",
  measurementId: "G-CS7C7LQVD5"
};
    try{
      firebaseApp = fb.initializeApp(FIREBASE_CONFIG);
      db = fs_mod.getFirestore(firebaseApp);
      $('#syncStatus').textContent = 'online';
    }catch(e){
      console.warn('Nu s-a putut ini»õializa Firebase:', e);
      $('#syncStatus').textContent = 'offline';
    }
  }

  const meetingKey = new Date().toISOString().slice(0,10);
  $('#meetingKey').textContent = meetingKey;

  const url = new URL(location.href);
  const token = url.searchParams.get('t');
  if(token) enterVoter(token);
  else { $('#secGate').classList.remove('hidden'); $('#roleBadge').textContent = 'Gateway'; }

  $('#btnSampleVoter').addEventListener('click', ()=>{ const demo = b64('demo|John Doe|10'); location.href = location.pathname + '?t=' + demo; });

  $('#btnOrgLogin').addEventListener('click', ()=>{
    const pass = $('#orgPass').value.trim();
    if(pass !== ORG_PASSWORD){ alert('ParolƒÉ incorectƒÉ'); return; }
    $('#secGate').classList.add('hidden'); $('#secOrganizer').classList.remove('hidden'); $('#roleBadge').textContent = 'Organizator';
    startOrganizer();
  });

  const state = { shareholders:[], agenda:[], links:[], chart:null, pingEnabled:true };

  $('#fileShareholders').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const text=await f.text(); state.shareholders=parseCSV(text); renderShareholders(); });
  $('#fileAgenda').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ state.agenda=JSON.parse(await f.text()); renderAgenda(); }catch{ alert('JSON invalid'); } });
  $('#btnLoadDemos').addEventListener('click', ()=>{ state.shareholders=[
      {id:'S001',name:'Popescu Ion',shares:120,email:'ion@ex.ro'},
      {id:'S002',name:'Ionescu Maria',shares:80,email:'maria@ex.ro'},
      {id:'S003',name:'Vasilescu Dan',shares:50,email:'dan@ex.ro'}
    ]; state.agenda=[
      {id:'p1',title:'Aprobarea situa»õiilor financiare pe anul precedent'},
      {id:'p2',title:'Bugetul pentru exerci»õiul curent'},
      {id:'p3',title:'Numirea auditorului financiar'}
    ]; renderShareholders(); renderAgenda(); });
  $('#btnClearAll').addEventListener('click', ()=>{ state.shareholders=[]; state.agenda=[]; state.links=[]; renderShareholders(); renderAgenda(); renderLinks(); });

  function parseCSV(text){ const rows=text.split(/\r?\n/).filter(r=>r.trim().length>0); const cols=rows[0].split(',').map(s=>s.trim().toLowerCase()); const idx=h=>cols.indexOf(h);
    const out=[]; for(let i=1;i<rows.length;i++){ const parts=rows[i].split(','); out.push({ id:parts[idx('id')]?.trim()||'', name:parts[idx('name')]?.trim()||'',
      shares:Number(parts[idx('shares')]?.trim()||'1'), email:parts[idx('email')]?.trim()||'' }); } return out; }

  function renderShareholders(){ const tb=$('#tblShareholders tbody'); tb.innerHTML=''; state.shareholders.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${s.id}</td><td>${s.name}</td><td>${s.shares}</td>`; tb.appendChild(tr); }); $('#kTotalSh').textContent=state.shareholders.length; }
  function renderAgenda(){ const tb=$('#tblAgenda tbody'); tb.innerHTML=''; state.agenda.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${p.id}</td><td>${p.title}</td>`; tb.appendChild(tr); }); }

  $('#btnGenerateLinks').addEventListener('click', ()=>{ if(state.shareholders.length===0){ alert('Importa»õi ac»õionari.'); return; }
    const base = location.origin + location.pathname;
    state.links = state.shareholders.map(s=>{ const t=b64([s.id,s.name,s.shares].join('|')); s.token=t; return {name:s.name, url:`${base}?t=${encodeURIComponent(t)}`}; });
    renderLinks();
  });
  $('#btnCopyAll').addEventListener('click', async ()=>{ const lines=state.links.map((l,i)=>`${i+1}. ${l.name} ‚Äî ${l.url}`).join('\n'); await navigator.clipboard.writeText(lines); alert('Lista copiatƒÉ.'); });
  function renderLinks(){ const tb=$('#tblLinks tbody'); tb.innerHTML=''; state.links.forEach((l,i)=>{ const tr=document.createElement('tr'); const id='copy_'+i;
    tr.innerHTML = `<td>${i+1}</td><td>${l.name}</td><td class="small"><a href="${l.url}" target="_blank">${l.url}</a></td><td><button class="btn secondary" id="${id}">Copy</button></td>`;
    tb.appendChild(tr); setTimeout(()=>{ const b=document.getElementById(id); if(b) b.onclick=async()=>{ await navigator.clipboard.writeText(l.url); b.textContent='Copied'; setTimeout(()=>b.textContent='Copy',1200); }; }, 0);
  }); }

  async function startOrganizer(){ await ensureFirebase();
    const start=Date.now(); setInterval(()=>{ const sec=Math.floor((Date.now()-start)/1000); $('#kTimer').textContent=`${fmt2(Math.floor(sec/60))}:${fmt2(sec%60)}`; },1000);
    const ctx=document.getElementById('liveChart'); const chart=new Chart(ctx, {type:'doughnut', data:{labels:['DA','NU','Ab»õinere'], datasets:[{data:[0,0,0]}]}, options:{responsive:true}}); state.chart = chart;
    if(!db) return;
    const { collection, onSnapshot } = fs_mod; const col = collection(db, 'votes', meetingKey, 'submissions');
    onSnapshot(col, (snap)=>{ let wDA=0,wNU=0,wAB=0; const recent=[]; snap.docChanges().forEach(ch=>{ if(ch.type==='added') ping(); });
      snap.forEach(doc=>{ const v=doc.data(); const items=v.items||{}; Object.keys(items).forEach(pid=>{ const it=items[pid]; const w=Number(it.weight||1);
        if(it.choice==='DA') wDA+=w; else if(it.choice==='NU') wNU+=w; else wAB+=w;
        recent.push({ t:new Date(v.createdAt||Date.now()).toLocaleTimeString(), voter:v.anon||doc.id, pid, choice:it.choice, w }); }); });
      chart.data.datasets[0].data=[wDA,wNU,wAB]; chart.update(); $('#kPresent').textContent = snap.size; $('#kCast').textContent = recent.length;
      const tb=$('#tblRecent tbody'); tb.innerHTML=''; recent.slice(-15).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.t}</td><td>${r.voter}</td><td>${r.pid}</td><td>${r.choice}</td><td>${r.w}</td>`; tb.appendChild(tr); });
    });
  }

  function ping(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='sine'; o.frequency.value=880; g.gain.value=0.03; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop(); ctx.close();},120); }catch{} }

  async function enterVoter(token){ $('#secGate').classList.add('hidden'); $('#secVoter').classList.remove('hidden'); $('#roleBadge').textContent='Votant';
    $('#voterToken').textContent = token.slice(0,10)+'‚Ä¶';
    let weight=1; try{ const [id,name,shares]=db64(token).split('|'); weight=Number(shares||1); }catch{} $('#voterWeight').textContent=weight;
    await ensureFirebase();
    let agenda=[{id:'p1',title:'Aprobarea situa»õiilor financiare pe anul precedent'},{id:'p2',title:'Bugetul pentru exerci»õiul curent'},{id:'p3',title:'Numirea auditorului financiar'}];
    if(db){ try{ const { doc, getDoc } = fs_mod; const ref=doc(db,'meetings',meetingKey); const snap=await getDoc(ref); if(snap.exists() && Array.isArray(snap.data().agenda)) agenda=snap.data().agenda; }catch{} }
    const root=$('#voterAgenda'); root.innerHTML=''; agenda.forEach((p,i)=>{ const box=document.createElement('div'); box.className='card'; box.style.border='1px dashed #e5e7eb';
      box.innerHTML = `<div><b>Punct ${i+1}.</b> ${p.title}</div>
        <div class='row' style='margin-top:8px'>
          <label><input type='radio' name='v_${p.id}' value='DA'> DA</label>
          <label><input type='radio' name='v_${p.id}' value='NU'> NU</label>
          <label><input type='radio' name='v_${p.id}' value='AB'> Ab»õinere</label>
        </div>`; root.appendChild(box);
    });
    $('#btnSubmitVote').onclick = async ()=>{ const choices={}; agenda.forEach(p=>{ const sel=document.querySelector(`input[name="v_${p.id}"]:checked`); choices[p.id]= sel?sel.value:'AB'; });
      const payload={ meeting:meetingKey, createdAt:Date.now(), anon:'h_'+token.slice(0,10), items:Object.fromEntries(Object.keys(choices).map(pid=>[pid,{choice:choices[pid],weight:weight}])) };
      if(ENV==='TEST'){ $('#voterThanks').classList.remove('hidden'); $('#btnSubmitVote').disabled=true; alert('Mod TEST: votul NU a fost scris √Æn Firestore.'); return; }
      if(!db){ alert('Config Firestore indisponibil.'); return; }
      try{ const { doc, setDoc, serverTimestamp } = fs_mod; const ref=doc(db,'votes',meetingKey,'submissions','h_'+token.slice(0,24)); await setDoc(ref, {...payload, serverAt: serverTimestamp()}, {merge:true}); }
      catch(e){ alert('Eroare la trimiterea votului. √éncerca»õi din nou.'); return; }
      $('#voterThanks').classList.remove('hidden'); $('#btnSubmitVote').disabled=true;
    };
  }
</script>
</body>
</html>
